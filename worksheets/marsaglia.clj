;; gorilla-repl.fileformat = 1

;; **
;;; # Marsaglia
;;; 
;;; In probabilistic programming systems like Anglican that support _continuous_ variables, recursion, and branching on nondeterminism it is possible to write procedures in the language itself that sample from distributions with uncountable support.  Another way of saying this is that we can denote constructive definitions of distribution over uncountable support and sample from the same.
;; **

;; @@
(ns marsaglia
  (:require [gorilla-plot.core :as plot])
  (:use clojure.repl
        [anglican core runtime emit [state :only [get-predicts]]] 
        [clojure.string :only (join split blank?)]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; We can generate from a normal distribution in a number of ways.  A canonical method is to use the Marsaglia algorithm.
;; **

;; @@
(defn marsaglia-normal [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal mean var))))
     
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal</span>","value":"#'marsaglia/marsaglia-normal"}
;; <=

;; **
;;; We can check that this generator produces a sample distribution that is in accordance with our understanding of the normal distribution, noting that a huge part of our understanding of the normal distribution is that we know how to compute the (log) density of a return value from from the marsaglia-normal procedure.
;; **

;; @@
(defn linspace [min max n]
   (let [step (/ (- max min) (dec n))] 
      (range min (+ max step) step)))

(def pi java.lang.Math/PI)
(defn normal-lnpdf
  "Log probability density of a sample x drawn from a univariate normal with
  known mean and standard deviation"
  [x mean std]
  (let [dx (- x mean)
        var (* std std)]
    (* -0.5
       (+ (log (* 2 (* pi var)))
          (/ (* dx dx) var)))))


(plot/compose  
  (plot/list-plot 
     (->> (linspace -5 10 100)
          (map #(into []  
                      [% (exp (normal-lnpdf % 2 2))]))
          (into [])) :joined true)
  
  (plot/histogram 
    (repeatedly 10000 
       (partial marsaglia-normal 2 4)) 
       :normalise :probability-density :bins 100))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"bottom":20,"top":10,"right":10,"left":50},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"ef15340a-cdbc-4de9-9d3d-95c80067398f","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"ef15340a-cdbc-4de9-9d3d-95c80067398f","field":"data.y"}}],"axes":[{"scale":"x","type":"x"},{"scale":"y","type":"y"}],"data":[{"name":"ef15340a-cdbc-4de9-9d3d-95c80067398f","values":[{"x":-5,"y":4.3634134752288024E-4},{"x":-4.848484848484848,"y":5.671970386513821E-4},{"x":-4.696969696969697,"y":7.330760541955561E-4},{"x":-4.545454545454545,"y":9.42044905076907E-4},{"x":-4.393939393939394,"y":0.0012036540160990396},{"x":-4.242424242424242,"y":0.0015291117517670808},{"x":-4.090909090909091,"y":0.001931453582514972},{"x":-3.939393939393939,"y":0.0024256984882430987},{"x":-3.787878787878788,"y":0.0030289831142058456},{"x":-3.636363636363636,"y":0.0037606626743546595},{"x":-3.484848484848485,"y":0.004642366243399356},{"x":-3.333333333333333,"y":0.0056979930118987235},{"x":-3.181818181818182,"y":0.0069536354318799525},{"x":-3.03030303030303,"y":0.008437415093311126},{"x":-2.878787878787879,"y":0.010179217781743341},{"x":-2.727272727272727,"y":0.01221031560013476},{"x":-2.575757575757576,"y":0.014562866395343413},{"x":-2.424242424242424,"y":0.01726928407836528},{"x":-2.272727272727273,"y":0.02036147778541647},{"x":-2.121212121212121,"y":0.023869963153426765},{"x":-1.96969696969697,"y":0.02782285516898323},{"x":-1.818181818181818,"y":0.032244758910466395},{"x":-1.666666666666667,"y":0.03715558177949653},{"x":-1.515151515151515,"y":0.04256929817839459},{"x":-1.363636363636364,"y":0.04849270464169628},{"x":-1.212121212121212,"y":0.05492420973253507},{"x":-1.060606060606061,"y":0.06185270810597594},{"x":-0.9090909090909091,"y":0.06925659156197403},{"x":-0.7575757575757576,"y":0.07710295123647007},{"x":-0.6060606060606061,"y":0.08534702395452404},{"x":-0.4545454545454545,"y":0.09393193193992498},{"x":-0.303030303030303,"y":0.10278875841821113},{"x":-0.1515151515151515,"y":0.11183699219670964},{"x":0,"y":0.12098536225957167},{"x":0.1515151515151515,"y":0.13013306915798126},{"x":0.303030303030303,"y":0.1391714040558564},{"x":0.4545454545454545,"y":0.14798572940993074},{"x":0.6060606060606061,"y":0.15645777823895984},{"x":0.7575757575757576,"y":0.1644682126638791},{"x":0.9090909090909091,"y":0.17189936779597245},{"x":1.060606060606061,"y":0.1786380949957625},{"x":1.212121212121212,"y":0.1845786098098487},{"x":1.363636363636364,"y":0.18962524515457918},{"x":1.515151515151515,"y":0.19369500999336653},{"x":1.666666666666667,"y":0.19671985805096995},{"x":1.818181818181818,"y":0.19864857996587085},{"x":1.96969696969697,"y":0.1994482453783368},{"x":2.121212121212121,"y":0.1991051382113847},{"x":2.272727272727273,"y":0.19762514802646214},{"x":2.424242424242424,"y":0.1950336018506434},{"x":2.575757575757576,"y":0.19137454318543307},{"x":2.727272727272727,"y":0.1867094868769894},{"x":2.878787878787879,"y":0.18111569903330255},{"x":3.03030303030303,"y":0.1746840691863272},{"x":3.181818181818182,"y":0.16751665654118497},{"x":3.333333333333333,"y":0.1597240027611761},{"x":3.484848484848485,"y":0.15142230988016647},{"x":3.636363636363636,"y":0.14273058344920247},{"x":3.787878787878788,"y":0.13376783801223838},{"x":3.939393939393939,"y":0.12465045481480101},{"x":4.090909090909091,"y":0.11548977084320669},{"x":4.242424242424242,"y":0.1063899646054096},{"x":4.393939393939394,"y":0.09744628834948768},{"x":4.545454545454545,"y":0.08874367958231379},{"x":4.696969696969697,"y":0.08035576770889953},{"x":4.848484848484848,"y":0.07234427521687625},{"x":5,"y":0.06475879783294586},{"x":5.151515151515152,"y":0.05763693509221288},{"x":5.303030303030303,"y":0.051004732236744024},{"x":5.454545454545455,"y":0.04487738657066214},{"x":5.606060606060606,"y":0.03926016644494569},{"x":5.757575757575758,"y":0.03414948886235444},{"x":5.909090909090909,"y":0.02953410207628975},{"x":6.060606060606061,"y":0.025396322187902023},{"x":6.212121212121212,"y":0.02171327722262099},{"x":6.363636363636364,"y":0.0184581180414643},{"x":6.515151515151515,"y":0.015601162248989789},{"x":6.666666666666667,"y":0.013110944546854752},{"x":6.818181818181818,"y":0.01095515433554187},{"x":6.96969696969697,"y":0.009101448429106639},{"x":7.121212121212121,"y":0.007518133229683001},{"x":7.272727272727273,"y":0.006174716395760555},{"x":7.424242424242424,"y":0.005042332792223683},{"x":7.575757575757576,"y":0.004094053263393624},{"x":7.727272727272727,"y":0.0033050875186944255},{"x":7.878787878787879,"y":0.002652894212643802},{"x":8.03030303030303,"y":0.002117212225924384},{"x":8.181818181818182,"y":0.0016800273299080965},{"x":8.333333333333332,"y":0.0013254879772150497},{"x":8.484848484848484,"y":0.0010397830454919879},{"x":8.636363636363637,"y":8.10993107200834E-4},{"x":8.787878787878787,"y":6.289253312080865E-4},{"x":8.93939393939394,"y":4.849405535559764E-4},{"x":9.090909090909092,"y":3.7177947793890046E-4},{"x":9.242424242424242,"y":2.833934545377709E-4},{"x":9.393939393939394,"y":2.1478389305454535E-4},{"x":9.545454545454545,"y":1.618531280464772E-4},{"x":9.696969696969697,"y":1.212684920196218E-4},{"x":9.848484848484848,"y":9.034047084076489E-5},{"x":10,"y":6.691511288244271E-5}]},{"name":"620c8139-5bee-4f71-b49f-741fb704a3fb","values":[{"x":-6.183216759838427,"y":0},{"x":-6.023936324186998,"y":6.278234962819983E-4},{"x":-5.8646558885355695,"y":0.0},{"x":-5.705375452884141,"y":0.0},{"x":-5.546095017232712,"y":0.0},{"x":-5.386814581581284,"y":0.0},{"x":-5.227534145929855,"y":0.0},{"x":-5.068253710278427,"y":0.0},{"x":-4.908973274626998,"y":6.278234962819983E-4},{"x":-4.7496928389755695,"y":0.0012556469925639965},{"x":-4.590412403324141,"y":6.278234962819983E-4},{"x":-4.431131967672712,"y":0.0},{"x":-4.271851532021284,"y":6.278234962819983E-4},{"x":-4.112571096369855,"y":0.002511293985127993},{"x":-3.953290660718426,"y":0.0012556469925639965},{"x":-3.794010225066997,"y":0.002511293985127993},{"x":-3.634729789415568,"y":0.0037669409776919897},{"x":-3.475449353764139,"y":0.0037669409776919897},{"x":-3.31616891811271,"y":0.0043947644739739875},{"x":-3.156888482461281,"y":0.006906058459101981},{"x":-2.997608046809852,"y":0.0075338819553839795},{"x":-2.838327611158423,"y":0.010045175940511972},{"x":-2.679047175506994,"y":0.01067299943679397},{"x":-2.519766739855565,"y":0.01757905789589595},{"x":-2.360486304204136,"y":0.015067763910767959},{"x":-2.201205868552707,"y":0.02260164586615194},{"x":-2.041925432901278,"y":0.023857292858715934},{"x":-1.882644997249849,"y":0.02197382236986994},{"x":-1.7233645615984199,"y":0.034530292295509905},{"x":-1.5640841259469909,"y":0.04269199774717588},{"x":-1.4048036902955618,"y":0.03892505676948389},{"x":-1.2455232546441328,"y":0.05650411466537984},{"x":-1.0862428189927038,"y":0.05838758515422584},{"x":-0.9269623833412748,"y":0.07910576053153179},{"x":-0.7676819476898458,"y":0.07659446654640378},{"x":-0.6084015120384167,"y":0.06592146710960982},{"x":-0.4491210763869877,"y":0.08852311297576175},{"x":-0.2898406407355587,"y":0.09542917143486374},{"x":-0.13056020508412972,"y":0.1073578178642217},{"x":0.028720230567299276,"y":0.12556469925639965},{"x":0.18800066621872827,"y":0.1406324631671676},{"x":0.34728110187015726,"y":0.13686552218947562},{"x":0.5065615375215863,"y":0.1418881101597316},{"x":0.6658419731730153,"y":0.16511757952216555},{"x":0.8251224088244443,"y":0.16009499155190957},{"x":0.9844028444758733,"y":0.17892969644036952},{"x":1.1436832801273022,"y":0.17453493196639552},{"x":1.3029637157787313,"y":0.1808131669292155},{"x":1.4622441514301603,"y":0.16637322651472955},{"x":1.6215245870815893,"y":0.18646357839575348},{"x":1.7808050227330183,"y":0.19588093083998345},{"x":1.9400854583844473,"y":0.19713657783254745},{"x":2.099365894035876,"y":0.19776440132882944},{"x":2.258646329687305,"y":0.20090351881023943},{"x":2.417926765338734,"y":0.19148616636600946},{"x":2.577207200990163,"y":0.19085834286972747},{"x":2.7364876366415922,"y":0.1814409904254975},{"x":2.8957680722930212,"y":0.16700105001101154},{"x":3.0550485079444503,"y":0.16700105001101154},{"x":3.2143289435958793,"y":0.1808131669292155},{"x":3.3736093792473083,"y":0.17076799098870352},{"x":3.5328898148987373,"y":0.15256110959652558},{"x":3.6921702505501663,"y":0.1450272276411416},{"x":3.8514506862015954,"y":0.1400046396708856},{"x":4.010731121853024,"y":0.12305340527127166},{"x":4.170011557504453,"y":0.11238040583447768},{"x":4.3292919931558815,"y":0.11238040583447768},{"x":4.48857242880731,"y":0.10359087688652971},{"x":4.647852864458739,"y":0.09103440696088975},{"x":4.807133300110167,"y":0.0759666430501218},{"x":4.966413735761596,"y":0.06717711410217382},{"x":5.125694171413024,"y":0.07408317256127579},{"x":5.284974607064453,"y":0.06717711410217382},{"x":5.444255042715882,"y":0.05022587970255986},{"x":5.60353547836731,"y":0.041436350754611884},{"x":5.762815914018739,"y":0.03829723327320189},{"x":5.922096349670167,"y":0.02448511635499793},{"x":6.081376785321596,"y":0.029507704325253917},{"x":6.240657220973024,"y":0.02511293985127993},{"x":6.399937656624453,"y":0.02134599887358794},{"x":6.559218092275882,"y":0.015067763910767959},{"x":6.71849852792731,"y":0.01067299943679397},{"x":6.877778963578739,"y":0.008161705451665977},{"x":7.037059399230167,"y":0.01067299943679397},{"x":7.196339834881596,"y":0.006278234962819982},{"x":7.3556202705330245,"y":0.0075338819553839795},{"x":7.514900706184453,"y":0.0043947644739739875},{"x":7.674181141835882,"y":0.0037669409776919897},{"x":7.83346157748731,"y":0.0037669409776919897},{"x":7.992742013138739,"y":0.005650411466537985},{"x":8.152022448790168,"y":0.0012556469925639965},{"x":8.311302884441597,"y":0.0018834704888459949},{"x":8.470583320093025,"y":0.0},{"x":8.629863755744454,"y":6.278234962819983E-4},{"x":8.789144191395883,"y":6.278234962819983E-4},{"x":8.948424627047311,"y":0.0},{"x":9.10770506269874,"y":6.278234962819983E-4},{"x":9.266985498350168,"y":0.0},{"x":9.426265934001597,"y":0.0012556469925639965},{"x":9.585546369653025,"y":0.0},{"x":9.744826805304454,"y":0.0},{"x":9.904107240955883,"y":6.278234962819983E-4},{"x":10.063387676607311,"y":0}]}],"marks":[{"type":"line","from":{"data":"ef15340a-cdbc-4de9-9d3d-95c80067398f"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"620c8139-5bee-4f71-b49f-741fb704a3fb"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:bottom 20, :top 10, :right 10, :left 50}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"ef15340a-cdbc-4de9-9d3d-95c80067398f\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"ef15340a-cdbc-4de9-9d3d-95c80067398f\", :field \"data.y\"}}], :axes [{:scale \"x\", :type \"x\"} {:scale \"y\", :type \"y\"}], :data ({:name \"ef15340a-cdbc-4de9-9d3d-95c80067398f\", :values ({:x -5, :y 4.3634134752288024E-4} {:x -160/33, :y 5.671970386513821E-4} {:x -155/33, :y 7.330760541955561E-4} {:x -50/11, :y 9.42044905076907E-4} {:x -145/33, :y 0.0012036540160990396} {:x -140/33, :y 0.0015291117517670808} {:x -45/11, :y 0.001931453582514972} {:x -130/33, :y 0.0024256984882430987} {:x -125/33, :y 0.0030289831142058456} {:x -40/11, :y 0.0037606626743546595} {:x -115/33, :y 0.004642366243399356} {:x -10/3, :y 0.0056979930118987235} {:x -35/11, :y 0.0069536354318799525} {:x -100/33, :y 0.008437415093311126} {:x -95/33, :y 0.010179217781743341} {:x -30/11, :y 0.01221031560013476} {:x -85/33, :y 0.014562866395343413} {:x -80/33, :y 0.01726928407836528} {:x -25/11, :y 0.02036147778541647} {:x -70/33, :y 0.023869963153426765} {:x -65/33, :y 0.02782285516898323} {:x -20/11, :y 0.032244758910466395} {:x -5/3, :y 0.03715558177949653} {:x -50/33, :y 0.04256929817839459} {:x -15/11, :y 0.04849270464169628} {:x -40/33, :y 0.05492420973253507} {:x -35/33, :y 0.06185270810597594} {:x -10/11, :y 0.06925659156197403} {:x -25/33, :y 0.07710295123647007} {:x -20/33, :y 0.08534702395452404} {:x -5/11, :y 0.09393193193992498} {:x -10/33, :y 0.10278875841821113} {:x -5/33, :y 0.11183699219670964} {:x 0N, :y 0.12098536225957167} {:x 5/33, :y 0.13013306915798126} {:x 10/33, :y 0.1391714040558564} {:x 5/11, :y 0.14798572940993074} {:x 20/33, :y 0.15645777823895984} {:x 25/33, :y 0.1644682126638791} {:x 10/11, :y 0.17189936779597245} {:x 35/33, :y 0.1786380949957625} {:x 40/33, :y 0.1845786098098487} {:x 15/11, :y 0.18962524515457918} {:x 50/33, :y 0.19369500999336653} {:x 5/3, :y 0.19671985805096995} {:x 20/11, :y 0.19864857996587085} {:x 65/33, :y 0.1994482453783368} {:x 70/33, :y 0.1991051382113847} {:x 25/11, :y 0.19762514802646214} {:x 80/33, :y 0.1950336018506434} {:x 85/33, :y 0.19137454318543307} {:x 30/11, :y 0.1867094868769894} {:x 95/33, :y 0.18111569903330255} {:x 100/33, :y 0.1746840691863272} {:x 35/11, :y 0.16751665654118497} {:x 10/3, :y 0.1597240027611761} {:x 115/33, :y 0.15142230988016647} {:x 40/11, :y 0.14273058344920247} {:x 125/33, :y 0.13376783801223838} {:x 130/33, :y 0.12465045481480101} {:x 45/11, :y 0.11548977084320669} {:x 140/33, :y 0.1063899646054096} {:x 145/33, :y 0.09744628834948768} {:x 50/11, :y 0.08874367958231379} {:x 155/33, :y 0.08035576770889953} {:x 160/33, :y 0.07234427521687625} {:x 5N, :y 0.06475879783294586} {:x 170/33, :y 0.05763693509221288} {:x 175/33, :y 0.051004732236744024} {:x 60/11, :y 0.04487738657066214} {:x 185/33, :y 0.03926016644494569} {:x 190/33, :y 0.03414948886235444} {:x 65/11, :y 0.02953410207628975} {:x 200/33, :y 0.025396322187902023} {:x 205/33, :y 0.02171327722262099} {:x 70/11, :y 0.0184581180414643} {:x 215/33, :y 0.015601162248989789} {:x 20/3, :y 0.013110944546854752} {:x 75/11, :y 0.01095515433554187} {:x 230/33, :y 0.009101448429106639} {:x 235/33, :y 0.007518133229683001} {:x 80/11, :y 0.006174716395760555} {:x 245/33, :y 0.005042332792223683} {:x 250/33, :y 0.004094053263393624} {:x 85/11, :y 0.0033050875186944255} {:x 260/33, :y 0.002652894212643802} {:x 265/33, :y 0.002117212225924384} {:x 90/11, :y 0.0016800273299080965} {:x 25/3, :y 0.0013254879772150497} {:x 280/33, :y 0.0010397830454919879} {:x 95/11, :y 8.10993107200834E-4} {:x 290/33, :y 6.289253312080865E-4} {:x 295/33, :y 4.849405535559764E-4} {:x 100/11, :y 3.7177947793890046E-4} {:x 305/33, :y 2.833934545377709E-4} {:x 310/33, :y 2.1478389305454535E-4} {:x 105/11, :y 1.618531280464772E-4} {:x 320/33, :y 1.212684920196218E-4} {:x 325/33, :y 9.034047084076489E-5} {:x 10N, :y 6.691511288244271E-5})} {:name \"620c8139-5bee-4f71-b49f-741fb704a3fb\", :values ({:x -6.183216759838427, :y 0} {:x -6.023936324186998, :y 6.278234962819983E-4} {:x -5.8646558885355695, :y 0.0} {:x -5.705375452884141, :y 0.0} {:x -5.546095017232712, :y 0.0} {:x -5.386814581581284, :y 0.0} {:x -5.227534145929855, :y 0.0} {:x -5.068253710278427, :y 0.0} {:x -4.908973274626998, :y 6.278234962819983E-4} {:x -4.7496928389755695, :y 0.0012556469925639965} {:x -4.590412403324141, :y 6.278234962819983E-4} {:x -4.431131967672712, :y 0.0} {:x -4.271851532021284, :y 6.278234962819983E-4} {:x -4.112571096369855, :y 0.002511293985127993} {:x -3.953290660718426, :y 0.0012556469925639965} {:x -3.794010225066997, :y 0.002511293985127993} {:x -3.634729789415568, :y 0.0037669409776919897} {:x -3.475449353764139, :y 0.0037669409776919897} {:x -3.31616891811271, :y 0.0043947644739739875} {:x -3.156888482461281, :y 0.006906058459101981} {:x -2.997608046809852, :y 0.0075338819553839795} {:x -2.838327611158423, :y 0.010045175940511972} {:x -2.679047175506994, :y 0.01067299943679397} {:x -2.519766739855565, :y 0.01757905789589595} {:x -2.360486304204136, :y 0.015067763910767959} {:x -2.201205868552707, :y 0.02260164586615194} {:x -2.041925432901278, :y 0.023857292858715934} {:x -1.882644997249849, :y 0.02197382236986994} {:x -1.7233645615984199, :y 0.034530292295509905} {:x -1.5640841259469909, :y 0.04269199774717588} {:x -1.4048036902955618, :y 0.03892505676948389} {:x -1.2455232546441328, :y 0.05650411466537984} {:x -1.0862428189927038, :y 0.05838758515422584} {:x -0.9269623833412748, :y 0.07910576053153179} {:x -0.7676819476898458, :y 0.07659446654640378} {:x -0.6084015120384167, :y 0.06592146710960982} {:x -0.4491210763869877, :y 0.08852311297576175} {:x -0.2898406407355587, :y 0.09542917143486374} {:x -0.13056020508412972, :y 0.1073578178642217} {:x 0.028720230567299276, :y 0.12556469925639965} {:x 0.18800066621872827, :y 0.1406324631671676} {:x 0.34728110187015726, :y 0.13686552218947562} {:x 0.5065615375215863, :y 0.1418881101597316} {:x 0.6658419731730153, :y 0.16511757952216555} {:x 0.8251224088244443, :y 0.16009499155190957} {:x 0.9844028444758733, :y 0.17892969644036952} {:x 1.1436832801273022, :y 0.17453493196639552} {:x 1.3029637157787313, :y 0.1808131669292155} {:x 1.4622441514301603, :y 0.16637322651472955} {:x 1.6215245870815893, :y 0.18646357839575348} {:x 1.7808050227330183, :y 0.19588093083998345} {:x 1.9400854583844473, :y 0.19713657783254745} {:x 2.099365894035876, :y 0.19776440132882944} {:x 2.258646329687305, :y 0.20090351881023943} {:x 2.417926765338734, :y 0.19148616636600946} {:x 2.577207200990163, :y 0.19085834286972747} {:x 2.7364876366415922, :y 0.1814409904254975} {:x 2.8957680722930212, :y 0.16700105001101154} {:x 3.0550485079444503, :y 0.16700105001101154} {:x 3.2143289435958793, :y 0.1808131669292155} {:x 3.3736093792473083, :y 0.17076799098870352} {:x 3.5328898148987373, :y 0.15256110959652558} {:x 3.6921702505501663, :y 0.1450272276411416} {:x 3.8514506862015954, :y 0.1400046396708856} {:x 4.010731121853024, :y 0.12305340527127166} {:x 4.170011557504453, :y 0.11238040583447768} {:x 4.3292919931558815, :y 0.11238040583447768} {:x 4.48857242880731, :y 0.10359087688652971} {:x 4.647852864458739, :y 0.09103440696088975} {:x 4.807133300110167, :y 0.0759666430501218} {:x 4.966413735761596, :y 0.06717711410217382} {:x 5.125694171413024, :y 0.07408317256127579} {:x 5.284974607064453, :y 0.06717711410217382} {:x 5.444255042715882, :y 0.05022587970255986} {:x 5.60353547836731, :y 0.041436350754611884} {:x 5.762815914018739, :y 0.03829723327320189} {:x 5.922096349670167, :y 0.02448511635499793} {:x 6.081376785321596, :y 0.029507704325253917} {:x 6.240657220973024, :y 0.02511293985127993} {:x 6.399937656624453, :y 0.02134599887358794} {:x 6.559218092275882, :y 0.015067763910767959} {:x 6.71849852792731, :y 0.01067299943679397} {:x 6.877778963578739, :y 0.008161705451665977} {:x 7.037059399230167, :y 0.01067299943679397} {:x 7.196339834881596, :y 0.006278234962819982} {:x 7.3556202705330245, :y 0.0075338819553839795} {:x 7.514900706184453, :y 0.0043947644739739875} {:x 7.674181141835882, :y 0.0037669409776919897} {:x 7.83346157748731, :y 0.0037669409776919897} {:x 7.992742013138739, :y 0.005650411466537985} {:x 8.152022448790168, :y 0.0012556469925639965} {:x 8.311302884441597, :y 0.0018834704888459949} {:x 8.470583320093025, :y 0.0} {:x 8.629863755744454, :y 6.278234962819983E-4} {:x 8.789144191395883, :y 6.278234962819983E-4} {:x 8.948424627047311, :y 0.0} {:x 9.10770506269874, :y 6.278234962819983E-4} {:x 9.266985498350168, :y 0.0} {:x 9.426265934001597, :y 0.0012556469925639965} {:x 9.585546369653025, :y 0.0} {:x 9.744826805304454, :y 0.0} {:x 9.904107240955883, :y 6.278234962819983E-4} {:x 10.063387676607311, :y 0})}), :marks ({:type \"line\", :from {:data \"ef15340a-cdbc-4de9-9d3d-95c80067398f\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"620c8139-5bee-4f71-b49f-741fb704a3fb\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; **
;;; What is interesting, however, is that one can't immediately deduce, even in this very simple example, that the return value from the `marsaglia-normal` procedure is "scorable" in the sense that it can be "observed" in Anglican. 
;;; 
;;; In order to define an observable distribution in Anglican one must make these procedures scorable which means, for now, manually deriving and providing a log-pdf/pmf calculator.  
;; **

;; @@
(defdist my-normal
  "univariate normal with parameters mean and _variance_"
  [m v] []
    (sample [this] (marsaglia-normal m v))
    (observe [this value] (normal-lnpdf value m (sqrt v))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#&lt;MultiFn clojure.lang.MultiFn@67b51fb2&gt;</span>","value":"#<MultiFn clojure.lang.MultiFn@67b51fb2>"}
;; <=

;; **
;;; This can now be included in any Anglican program and used as a distribution, to be observed, etc.
;;; 
;;; Alternatively we can also include the sampling procedure directly by defm'ing it which produces a CPS version.
;; **

;; @@
(defm marsaglia-normal-cps [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal-cps mean var))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal-cps</span>","value":"#'marsaglia/marsaglia-normal-cps"}
;; <=

;; **
;;; What is interesting about this is that it exposes the internal random state of the `marsaglia-normal` to the inference engine.  This may or may not be a good idea depending on a number of issues.
;;; 
;;; Here is the Gaussian unknown mean example from the Anglican paper. With the internal uniform continuous draws exposed to inference.
;;; 
;;; 
;; **

;; @@
(defquery unknown-mean-internals-exposed [d] 
    (let [sigma (sqrt 2)
          mu (marsaglia-normal-cps 1 5)]
      
          (observe (normal mu sigma) 9)
          (observe (normal mu sigma) 8)

          (predict :mu mu)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-internals-exposed</span>","value":"#'marsaglia/unknown-mean-internals-exposed"}
;; <=

;; **
;;; And here is the same but with the internals hidden from inference.
;; **

;; @@
  (def data [9 8])
  (with-primitive-procedures [my-normal] 
    (defquery unknown-mean-internals-hidden [d] 
      (let [sigma (sqrt 2)
            mu (sample (my-normal 1 5))
            obsdist (my-normal mu sigma)]
              (map (fn [d] (observe obsdist d)) data)
              (predict :mu mu))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-internals-hidden</span>","value":"#'marsaglia/unknown-mean-internals-hidden"}
;; <=

;; **
;;; |And here are the results.  (green: internals exposed, blue: internals hidden)
;; **

;; @@



(plot/compose  
  (plot/list-plot 
     (->> (linspace 3 11 100)
          (map #(into []  
                      [% (exp (observe (my-normal 7.25 0.913) %))]))
          (into [])) :joined true)
  
     (->> (doquery :lmh unknown-mean-internals-exposed nil)
        (map get-predicts)
        (map :mu)
        (take 20000)
        (#(plot/histogram % :normalize :probability-density :bins 100 :color "#5A0")))
     (->> (doquery :lmh unknown-mean-internals-hidden nil)
        (map get-predicts)
        (map :mu)
        (take 20000)
        (#(plot/histogram % :normalize :probability-density :bins 100 :color "#05A"))))


  {:internals-exposed (->> (doquery :lmh unknown-mean-internals-exposed nil)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(/ (reduce + %) (count %))))}

  {:internals-hidden (->> (doquery :lmh unknown-mean-internals-hidden nil)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(/ (reduce + %) (count %))))}
      
  
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:internals-hidden</span>","value":":internals-hidden"},{"type":"html","content":"<span class='clj-double'>7.697004797757858</span>","value":"7.697004797757858"}],"value":"[:internals-hidden 7.697004797757858]"}],"value":"{:internals-hidden 7.697004797757858}"}
;; <=

;; **
;;; Which is near the analytical posterior of $$\mathrm{Normal}(7.25,.913^2)$$
;; **

;; @@

;; @@
