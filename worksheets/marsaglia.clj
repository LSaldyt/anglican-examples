;; gorilla-repl.fileformat = 1

;; **
;;; # Marsaglia
;;; 
;;; In probabilistic programming systems like Anglican that support _continuous_ variables, recursion, and branching on nondeterminism it is possible to write procedures in the language itself that sample from distributions with uncountable support.  Another way of saying this is that we can denote constructive definitions of distribution over uncountable support and sample from the same.
;; **

;; @@
(ns marsaglia
  (:require [gorilla-plot.core :as plot])
  (:use clojure.repl
        [anglican core runtime emit [state :only [get-predicts]]] 
        [clojure.string :only (join split blank?)]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; We can generate from a normal distribution in a number of ways.  A canonical method is to use the Marsaglia algorithm.
;; **

;; @@
(defn marsaglia-normal [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal mean var))))
     
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal</span>","value":"#'marsaglia/marsaglia-normal"}
;; <=

;; **
;;; We can check that this generator produces a sample distribution that is in accordance with our understanding of the normal distribution, noting that a huge part of our understanding of the normal distribution is that we know how to compute the (log) density of a return value from from the marsaglia-normal procedure.
;; **

;; @@
(defn linspace [min max n]
   (let [step (/ (- max min) (dec n))] 
      (range min (+ max step) step)))

(def pi java.lang.Math/PI)
(defn normal-lnpdf
  "Log probability density of a sample x drawn from a univariate normal with
  known mean and standard deviation"
  [x mean std]
  (let [dx (- x mean)
        var (* std std)]
    (* -0.5
       (+ (log (* 2 (* pi var)))
          (/ (* dx dx) var)))))


(plot/compose  
  (plot/list-plot 
     (->> (linspace -5 10 100)
          (map #(into []  
                      [% (exp (normal-lnpdf % 2 2))]))
          (into [])) :joined true)
  
  (plot/histogram 
    (repeatedly 10000 
       (partial marsaglia-normal 2 4)) 
       :normalise :probability-density :bins 100))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"bottom":20,"top":10,"right":10,"left":50},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"ef9d075e-a528-41c3-82fb-ddc26ebd9850","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"ef9d075e-a528-41c3-82fb-ddc26ebd9850","field":"data.y"}}],"axes":[{"scale":"x","type":"x"},{"scale":"y","type":"y"}],"data":[{"name":"ef9d075e-a528-41c3-82fb-ddc26ebd9850","values":[{"x":-5,"y":4.3634134752288024E-4},{"x":-4.848484848484848,"y":5.671970386513821E-4},{"x":-4.696969696969697,"y":7.330760541955561E-4},{"x":-4.545454545454545,"y":9.42044905076907E-4},{"x":-4.393939393939394,"y":0.0012036540160990396},{"x":-4.242424242424242,"y":0.0015291117517670808},{"x":-4.090909090909091,"y":0.001931453582514972},{"x":-3.939393939393939,"y":0.0024256984882430987},{"x":-3.787878787878788,"y":0.0030289831142058456},{"x":-3.636363636363636,"y":0.0037606626743546595},{"x":-3.484848484848485,"y":0.004642366243399356},{"x":-3.333333333333333,"y":0.0056979930118987235},{"x":-3.181818181818182,"y":0.0069536354318799525},{"x":-3.03030303030303,"y":0.008437415093311126},{"x":-2.878787878787879,"y":0.010179217781743341},{"x":-2.727272727272727,"y":0.01221031560013476},{"x":-2.575757575757576,"y":0.014562866395343413},{"x":-2.424242424242424,"y":0.01726928407836528},{"x":-2.272727272727273,"y":0.02036147778541647},{"x":-2.121212121212121,"y":0.023869963153426765},{"x":-1.96969696969697,"y":0.02782285516898323},{"x":-1.818181818181818,"y":0.032244758910466395},{"x":-1.666666666666667,"y":0.03715558177949653},{"x":-1.515151515151515,"y":0.04256929817839459},{"x":-1.363636363636364,"y":0.04849270464169628},{"x":-1.212121212121212,"y":0.05492420973253507},{"x":-1.060606060606061,"y":0.06185270810597594},{"x":-0.9090909090909091,"y":0.06925659156197403},{"x":-0.7575757575757576,"y":0.07710295123647007},{"x":-0.6060606060606061,"y":0.08534702395452404},{"x":-0.4545454545454545,"y":0.09393193193992498},{"x":-0.303030303030303,"y":0.10278875841821113},{"x":-0.1515151515151515,"y":0.11183699219670964},{"x":0,"y":0.12098536225957167},{"x":0.1515151515151515,"y":0.13013306915798126},{"x":0.303030303030303,"y":0.1391714040558564},{"x":0.4545454545454545,"y":0.14798572940993074},{"x":0.6060606060606061,"y":0.15645777823895984},{"x":0.7575757575757576,"y":0.1644682126638791},{"x":0.9090909090909091,"y":0.17189936779597245},{"x":1.060606060606061,"y":0.1786380949957625},{"x":1.212121212121212,"y":0.1845786098098487},{"x":1.363636363636364,"y":0.18962524515457918},{"x":1.515151515151515,"y":0.19369500999336653},{"x":1.666666666666667,"y":0.19671985805096995},{"x":1.818181818181818,"y":0.19864857996587085},{"x":1.96969696969697,"y":0.1994482453783368},{"x":2.121212121212121,"y":0.1991051382113847},{"x":2.272727272727273,"y":0.19762514802646214},{"x":2.424242424242424,"y":0.1950336018506434},{"x":2.575757575757576,"y":0.19137454318543307},{"x":2.727272727272727,"y":0.1867094868769894},{"x":2.878787878787879,"y":0.18111569903330255},{"x":3.03030303030303,"y":0.1746840691863272},{"x":3.181818181818182,"y":0.16751665654118497},{"x":3.333333333333333,"y":0.1597240027611761},{"x":3.484848484848485,"y":0.15142230988016647},{"x":3.636363636363636,"y":0.14273058344920247},{"x":3.787878787878788,"y":0.13376783801223838},{"x":3.939393939393939,"y":0.12465045481480101},{"x":4.090909090909091,"y":0.11548977084320669},{"x":4.242424242424242,"y":0.1063899646054096},{"x":4.393939393939394,"y":0.09744628834948768},{"x":4.545454545454545,"y":0.08874367958231379},{"x":4.696969696969697,"y":0.08035576770889953},{"x":4.848484848484848,"y":0.07234427521687625},{"x":5,"y":0.06475879783294586},{"x":5.151515151515152,"y":0.05763693509221288},{"x":5.303030303030303,"y":0.051004732236744024},{"x":5.454545454545455,"y":0.04487738657066214},{"x":5.606060606060606,"y":0.03926016644494569},{"x":5.757575757575758,"y":0.03414948886235444},{"x":5.909090909090909,"y":0.02953410207628975},{"x":6.060606060606061,"y":0.025396322187902023},{"x":6.212121212121212,"y":0.02171327722262099},{"x":6.363636363636364,"y":0.0184581180414643},{"x":6.515151515151515,"y":0.015601162248989789},{"x":6.666666666666667,"y":0.013110944546854752},{"x":6.818181818181818,"y":0.01095515433554187},{"x":6.96969696969697,"y":0.009101448429106639},{"x":7.121212121212121,"y":0.007518133229683001},{"x":7.272727272727273,"y":0.006174716395760555},{"x":7.424242424242424,"y":0.005042332792223683},{"x":7.575757575757576,"y":0.004094053263393624},{"x":7.727272727272727,"y":0.0033050875186944255},{"x":7.878787878787879,"y":0.002652894212643802},{"x":8.03030303030303,"y":0.002117212225924384},{"x":8.181818181818182,"y":0.0016800273299080965},{"x":8.333333333333332,"y":0.0013254879772150497},{"x":8.484848484848484,"y":0.0010397830454919879},{"x":8.636363636363637,"y":8.10993107200834E-4},{"x":8.787878787878787,"y":6.289253312080865E-4},{"x":8.93939393939394,"y":4.849405535559764E-4},{"x":9.090909090909092,"y":3.7177947793890046E-4},{"x":9.242424242424242,"y":2.833934545377709E-4},{"x":9.393939393939394,"y":2.1478389305454535E-4},{"x":9.545454545454545,"y":1.618531280464772E-4},{"x":9.696969696969697,"y":1.212684920196218E-4},{"x":9.848484848484848,"y":9.034047084076489E-5},{"x":10,"y":6.691511288244271E-5}]},{"name":"d435ea45-851b-41cb-8613-c6da8a1f1b4d","values":[{"x":-5.09171814316849,"y":0},{"x":-4.938502809804939,"y":0.0013053523796175042},{"x":-4.785287476441389,"y":0.0},{"x":-4.632072143077838,"y":6.526761898087521E-4},{"x":-4.478856809714288,"y":6.526761898087521E-4},{"x":-4.325641476350738,"y":0.0013053523796175042},{"x":-4.172426142987187,"y":6.526761898087521E-4},{"x":-4.019210809623637,"y":0.0026107047592350083},{"x":-3.8659954762600863,"y":6.526761898087521E-4},{"x":-3.712780142896536,"y":0.0032633809490437604},{"x":-3.5595648095329855,"y":0.004568733328661264},{"x":-3.406349476169435,"y":0.0039160571388525125},{"x":-3.2531341428058846,"y":0.009137466657322528},{"x":-3.0999188094423342,"y":0.0032633809490437604},{"x":-2.946703476078784,"y":0.00979014284713128},{"x":-2.7934881427152334,"y":0.013053523796175042},{"x":-2.640272809351683,"y":0.011748171416557537},{"x":-2.4870574759881325,"y":0.020885638073880067},{"x":-2.333842142624582,"y":0.016969580935027553},{"x":-2.1806268092610317,"y":0.02219099045349757},{"x":-2.0274114758974813,"y":0.021538314263688817},{"x":-1.8741961425339306,"y":0.021538314263688817},{"x":-1.72098080917038,"y":0.03328648568024636},{"x":-1.5677654758068293,"y":0.0326338094904376},{"x":-1.4145501424432787,"y":0.048298038045847654},{"x":-1.261334809079728,"y":0.05417212375412642},{"x":-1.1081194757161774,"y":0.05743550470317018},{"x":-0.9549041423526268,"y":0.06200423803183144},{"x":-0.8016888089890761,"y":0.08484790467513777},{"x":-0.6484734756255255,"y":0.08223719991590275},{"x":-0.49525814226197484,"y":0.10051213323054782},{"x":-0.3420428088984242,"y":0.08288987610571151},{"x":-0.18882747553487356,"y":0.10181748561016532},{"x":-0.035612142171322914,"y":0.11878706654519287},{"x":0.11760319119222773,"y":0.1266191808228979},{"x":0.2708185245557784,"y":0.12988256177194166},{"x":0.424033857919329,"y":0.14097805699869045},{"x":0.5772491912828797,"y":0.13706199985983794},{"x":0.7304645246464303,"y":0.16382172364199676},{"x":0.883679858009981,"y":0.157947637933718},{"x":1.0368951913735316,"y":0.155336933174483},{"x":1.1901105247370822,"y":0.20232961884071313},{"x":1.3433258581006329,"y":0.20232961884071313},{"x":1.4965411914641835,"y":0.18862341885472933},{"x":1.6497565248277342,"y":0.1918867998037731},{"x":1.8029718581912848,"y":0.19253947599358184},{"x":1.9561871915548354,"y":0.20624567597956564},{"x":2.1094025249183863,"y":0.1958028569426256},{"x":2.2626178582819367,"y":0.2068983521693744},{"x":2.415833191645487,"y":0.20755102835918315},{"x":2.5690485250090376,"y":0.21864652358593192},{"x":2.722263858372588,"y":0.15860031412352674},{"x":2.8754791917361384,"y":0.18731806647511184},{"x":3.028694525099689,"y":0.17948595219740682},{"x":3.1819098584632393,"y":0.16773778078084928},{"x":3.3351251918267897,"y":0.155336933174483},{"x":3.48834052519034,"y":0.14032538080888168},{"x":3.6415558585538905,"y":0.1468521427069692},{"x":3.794771191917441,"y":0.14228340937830794},{"x":3.9479865252809914,"y":0.1253138284432804},{"x":4.101201858644542,"y":0.12205044749423663},{"x":4.254417192008092,"y":0.11095495226748785},{"x":4.407632525371643,"y":0.10247016179997408},{"x":4.560847858735193,"y":0.08223719991590275},{"x":4.7140631920987435,"y":0.08288987610571151},{"x":4.867278525462294,"y":0.06918367611972771},{"x":5.020493858825844,"y":0.06461494279106646},{"x":5.173709192189395,"y":0.061351561842022694},{"x":5.326924525552945,"y":0.054824799943935174},{"x":5.480139858916496,"y":0.0489507142356564},{"x":5.633355192280046,"y":0.04046592376814263},{"x":5.786570525643596,"y":0.0313284571108201},{"x":5.939785859007147,"y":0.03785521900890762},{"x":6.093001192370697,"y":0.026759723782158833},{"x":6.246216525734248,"y":0.026107047592350083},{"x":6.399431859097798,"y":0.013706199985983793},{"x":6.5526471924613485,"y":0.02284366664330632},{"x":6.705862525824899,"y":0.004568733328661264},{"x":6.859077859188449,"y":0.012400847606366288},{"x":7.012293192552,"y":0.013053523796175042},{"x":7.16550852591555,"y":0.007832114277705025},{"x":7.318723859279101,"y":0.004568733328661264},{"x":7.471939192642651,"y":0.004568733328661264},{"x":7.6251545260062015,"y":0.0026107047592350083},{"x":7.778369859369752,"y":0.0039160571388525125},{"x":7.931585192733302,"y":0.0026107047592350083},{"x":8.084800526096853,"y":0.0019580285694262563},{"x":8.238015859460404,"y":0.0039160571388525125},{"x":8.391231192823955,"y":0.0013053523796175042},{"x":8.544446526187507,"y":0.0019580285694262563},{"x":8.697661859551058,"y":6.526761898087521E-4},{"x":8.85087719291461,"y":0.0019580285694262563},{"x":9.00409252627816,"y":0.0},{"x":9.157307859641712,"y":6.526761898087521E-4},{"x":9.310523193005263,"y":6.526761898087521E-4},{"x":9.463738526368815,"y":6.526761898087521E-4},{"x":9.616953859732366,"y":0.0},{"x":9.770169193095917,"y":0.0},{"x":9.923384526459468,"y":6.526761898087521E-4},{"x":10.07659985982302,"y":6.526761898087521E-4},{"x":10.229815193186571,"y":0.0},{"x":10.383030526550122,"y":6.526761898087521E-4},{"x":10.536245859913674,"y":0}]}],"marks":[{"type":"line","from":{"data":"ef9d075e-a528-41c3-82fb-ddc26ebd9850"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"d435ea45-851b-41cb-8613-c6da8a1f1b4d"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:bottom 20, :top 10, :right 10, :left 50}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"ef9d075e-a528-41c3-82fb-ddc26ebd9850\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"ef9d075e-a528-41c3-82fb-ddc26ebd9850\", :field \"data.y\"}}], :axes [{:scale \"x\", :type \"x\"} {:scale \"y\", :type \"y\"}], :data ({:name \"ef9d075e-a528-41c3-82fb-ddc26ebd9850\", :values ({:x -5, :y 4.3634134752288024E-4} {:x -160/33, :y 5.671970386513821E-4} {:x -155/33, :y 7.330760541955561E-4} {:x -50/11, :y 9.42044905076907E-4} {:x -145/33, :y 0.0012036540160990396} {:x -140/33, :y 0.0015291117517670808} {:x -45/11, :y 0.001931453582514972} {:x -130/33, :y 0.0024256984882430987} {:x -125/33, :y 0.0030289831142058456} {:x -40/11, :y 0.0037606626743546595} {:x -115/33, :y 0.004642366243399356} {:x -10/3, :y 0.0056979930118987235} {:x -35/11, :y 0.0069536354318799525} {:x -100/33, :y 0.008437415093311126} {:x -95/33, :y 0.010179217781743341} {:x -30/11, :y 0.01221031560013476} {:x -85/33, :y 0.014562866395343413} {:x -80/33, :y 0.01726928407836528} {:x -25/11, :y 0.02036147778541647} {:x -70/33, :y 0.023869963153426765} {:x -65/33, :y 0.02782285516898323} {:x -20/11, :y 0.032244758910466395} {:x -5/3, :y 0.03715558177949653} {:x -50/33, :y 0.04256929817839459} {:x -15/11, :y 0.04849270464169628} {:x -40/33, :y 0.05492420973253507} {:x -35/33, :y 0.06185270810597594} {:x -10/11, :y 0.06925659156197403} {:x -25/33, :y 0.07710295123647007} {:x -20/33, :y 0.08534702395452404} {:x -5/11, :y 0.09393193193992498} {:x -10/33, :y 0.10278875841821113} {:x -5/33, :y 0.11183699219670964} {:x 0N, :y 0.12098536225957167} {:x 5/33, :y 0.13013306915798126} {:x 10/33, :y 0.1391714040558564} {:x 5/11, :y 0.14798572940993074} {:x 20/33, :y 0.15645777823895984} {:x 25/33, :y 0.1644682126638791} {:x 10/11, :y 0.17189936779597245} {:x 35/33, :y 0.1786380949957625} {:x 40/33, :y 0.1845786098098487} {:x 15/11, :y 0.18962524515457918} {:x 50/33, :y 0.19369500999336653} {:x 5/3, :y 0.19671985805096995} {:x 20/11, :y 0.19864857996587085} {:x 65/33, :y 0.1994482453783368} {:x 70/33, :y 0.1991051382113847} {:x 25/11, :y 0.19762514802646214} {:x 80/33, :y 0.1950336018506434} {:x 85/33, :y 0.19137454318543307} {:x 30/11, :y 0.1867094868769894} {:x 95/33, :y 0.18111569903330255} {:x 100/33, :y 0.1746840691863272} {:x 35/11, :y 0.16751665654118497} {:x 10/3, :y 0.1597240027611761} {:x 115/33, :y 0.15142230988016647} {:x 40/11, :y 0.14273058344920247} {:x 125/33, :y 0.13376783801223838} {:x 130/33, :y 0.12465045481480101} {:x 45/11, :y 0.11548977084320669} {:x 140/33, :y 0.1063899646054096} {:x 145/33, :y 0.09744628834948768} {:x 50/11, :y 0.08874367958231379} {:x 155/33, :y 0.08035576770889953} {:x 160/33, :y 0.07234427521687625} {:x 5N, :y 0.06475879783294586} {:x 170/33, :y 0.05763693509221288} {:x 175/33, :y 0.051004732236744024} {:x 60/11, :y 0.04487738657066214} {:x 185/33, :y 0.03926016644494569} {:x 190/33, :y 0.03414948886235444} {:x 65/11, :y 0.02953410207628975} {:x 200/33, :y 0.025396322187902023} {:x 205/33, :y 0.02171327722262099} {:x 70/11, :y 0.0184581180414643} {:x 215/33, :y 0.015601162248989789} {:x 20/3, :y 0.013110944546854752} {:x 75/11, :y 0.01095515433554187} {:x 230/33, :y 0.009101448429106639} {:x 235/33, :y 0.007518133229683001} {:x 80/11, :y 0.006174716395760555} {:x 245/33, :y 0.005042332792223683} {:x 250/33, :y 0.004094053263393624} {:x 85/11, :y 0.0033050875186944255} {:x 260/33, :y 0.002652894212643802} {:x 265/33, :y 0.002117212225924384} {:x 90/11, :y 0.0016800273299080965} {:x 25/3, :y 0.0013254879772150497} {:x 280/33, :y 0.0010397830454919879} {:x 95/11, :y 8.10993107200834E-4} {:x 290/33, :y 6.289253312080865E-4} {:x 295/33, :y 4.849405535559764E-4} {:x 100/11, :y 3.7177947793890046E-4} {:x 305/33, :y 2.833934545377709E-4} {:x 310/33, :y 2.1478389305454535E-4} {:x 105/11, :y 1.618531280464772E-4} {:x 320/33, :y 1.212684920196218E-4} {:x 325/33, :y 9.034047084076489E-5} {:x 10N, :y 6.691511288244271E-5})} {:name \"d435ea45-851b-41cb-8613-c6da8a1f1b4d\", :values ({:x -5.09171814316849, :y 0} {:x -4.938502809804939, :y 0.0013053523796175042} {:x -4.785287476441389, :y 0.0} {:x -4.632072143077838, :y 6.526761898087521E-4} {:x -4.478856809714288, :y 6.526761898087521E-4} {:x -4.325641476350738, :y 0.0013053523796175042} {:x -4.172426142987187, :y 6.526761898087521E-4} {:x -4.019210809623637, :y 0.0026107047592350083} {:x -3.8659954762600863, :y 6.526761898087521E-4} {:x -3.712780142896536, :y 0.0032633809490437604} {:x -3.5595648095329855, :y 0.004568733328661264} {:x -3.406349476169435, :y 0.0039160571388525125} {:x -3.2531341428058846, :y 0.009137466657322528} {:x -3.0999188094423342, :y 0.0032633809490437604} {:x -2.946703476078784, :y 0.00979014284713128} {:x -2.7934881427152334, :y 0.013053523796175042} {:x -2.640272809351683, :y 0.011748171416557537} {:x -2.4870574759881325, :y 0.020885638073880067} {:x -2.333842142624582, :y 0.016969580935027553} {:x -2.1806268092610317, :y 0.02219099045349757} {:x -2.0274114758974813, :y 0.021538314263688817} {:x -1.8741961425339306, :y 0.021538314263688817} {:x -1.72098080917038, :y 0.03328648568024636} {:x -1.5677654758068293, :y 0.0326338094904376} {:x -1.4145501424432787, :y 0.048298038045847654} {:x -1.261334809079728, :y 0.05417212375412642} {:x -1.1081194757161774, :y 0.05743550470317018} {:x -0.9549041423526268, :y 0.06200423803183144} {:x -0.8016888089890761, :y 0.08484790467513777} {:x -0.6484734756255255, :y 0.08223719991590275} {:x -0.49525814226197484, :y 0.10051213323054782} {:x -0.3420428088984242, :y 0.08288987610571151} {:x -0.18882747553487356, :y 0.10181748561016532} {:x -0.035612142171322914, :y 0.11878706654519287} {:x 0.11760319119222773, :y 0.1266191808228979} {:x 0.2708185245557784, :y 0.12988256177194166} {:x 0.424033857919329, :y 0.14097805699869045} {:x 0.5772491912828797, :y 0.13706199985983794} {:x 0.7304645246464303, :y 0.16382172364199676} {:x 0.883679858009981, :y 0.157947637933718} {:x 1.0368951913735316, :y 0.155336933174483} {:x 1.1901105247370822, :y 0.20232961884071313} {:x 1.3433258581006329, :y 0.20232961884071313} {:x 1.4965411914641835, :y 0.18862341885472933} {:x 1.6497565248277342, :y 0.1918867998037731} {:x 1.8029718581912848, :y 0.19253947599358184} {:x 1.9561871915548354, :y 0.20624567597956564} {:x 2.1094025249183863, :y 0.1958028569426256} {:x 2.2626178582819367, :y 0.2068983521693744} {:x 2.415833191645487, :y 0.20755102835918315} {:x 2.5690485250090376, :y 0.21864652358593192} {:x 2.722263858372588, :y 0.15860031412352674} {:x 2.8754791917361384, :y 0.18731806647511184} {:x 3.028694525099689, :y 0.17948595219740682} {:x 3.1819098584632393, :y 0.16773778078084928} {:x 3.3351251918267897, :y 0.155336933174483} {:x 3.48834052519034, :y 0.14032538080888168} {:x 3.6415558585538905, :y 0.1468521427069692} {:x 3.794771191917441, :y 0.14228340937830794} {:x 3.9479865252809914, :y 0.1253138284432804} {:x 4.101201858644542, :y 0.12205044749423663} {:x 4.254417192008092, :y 0.11095495226748785} {:x 4.407632525371643, :y 0.10247016179997408} {:x 4.560847858735193, :y 0.08223719991590275} {:x 4.7140631920987435, :y 0.08288987610571151} {:x 4.867278525462294, :y 0.06918367611972771} {:x 5.020493858825844, :y 0.06461494279106646} {:x 5.173709192189395, :y 0.061351561842022694} {:x 5.326924525552945, :y 0.054824799943935174} {:x 5.480139858916496, :y 0.0489507142356564} {:x 5.633355192280046, :y 0.04046592376814263} {:x 5.786570525643596, :y 0.0313284571108201} {:x 5.939785859007147, :y 0.03785521900890762} {:x 6.093001192370697, :y 0.026759723782158833} {:x 6.246216525734248, :y 0.026107047592350083} {:x 6.399431859097798, :y 0.013706199985983793} {:x 6.5526471924613485, :y 0.02284366664330632} {:x 6.705862525824899, :y 0.004568733328661264} {:x 6.859077859188449, :y 0.012400847606366288} {:x 7.012293192552, :y 0.013053523796175042} {:x 7.16550852591555, :y 0.007832114277705025} {:x 7.318723859279101, :y 0.004568733328661264} {:x 7.471939192642651, :y 0.004568733328661264} {:x 7.6251545260062015, :y 0.0026107047592350083} {:x 7.778369859369752, :y 0.0039160571388525125} {:x 7.931585192733302, :y 0.0026107047592350083} {:x 8.084800526096853, :y 0.0019580285694262563} {:x 8.238015859460404, :y 0.0039160571388525125} {:x 8.391231192823955, :y 0.0013053523796175042} {:x 8.544446526187507, :y 0.0019580285694262563} {:x 8.697661859551058, :y 6.526761898087521E-4} {:x 8.85087719291461, :y 0.0019580285694262563} {:x 9.00409252627816, :y 0.0} {:x 9.157307859641712, :y 6.526761898087521E-4} {:x 9.310523193005263, :y 6.526761898087521E-4} {:x 9.463738526368815, :y 6.526761898087521E-4} {:x 9.616953859732366, :y 0.0} {:x 9.770169193095917, :y 0.0} {:x 9.923384526459468, :y 6.526761898087521E-4} {:x 10.07659985982302, :y 6.526761898087521E-4} {:x 10.229815193186571, :y 0.0} {:x 10.383030526550122, :y 6.526761898087521E-4} {:x 10.536245859913674, :y 0})}), :marks ({:type \"line\", :from {:data \"ef9d075e-a528-41c3-82fb-ddc26ebd9850\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"d435ea45-851b-41cb-8613-c6da8a1f1b4d\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; **
;;; What is interesting, however, is that one can't immediately deduce, even in this very simple example, that the return value from the `marsaglia-normal` procedure is "scorable" in the sense that it can be "observed" in Anglican. 
;;; 
;;; In order to define an observable distribution in Anglican one must make these procedures scorable which means, for now, manually deriving and providing a log-pdf/pmf calculator.  
;; **

;; @@
(defdist my-normal
  "univariate normal with parameters mean and _variance_"
  [m v] []
    (sample [this] (marsaglia-normal m v))
    (observe [this value] (normal-lnpdf value m (sqrt v))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#&lt;MultiFn clojure.lang.MultiFn@67b51fb2&gt;</span>","value":"#<MultiFn clojure.lang.MultiFn@67b51fb2>"}
;; <=

;; **
;;; This can now be included in any Anglican program and used as a distribution, to be observed, etc.
;;; 
;;; Alternatively we can also include the sampling procedure directly by defm'ing it which produces a CPS version.
;; **

;; @@
(defm marsaglia-normal-cps [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal-cps mean var))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal-cps</span>","value":"#'marsaglia/marsaglia-normal-cps"}
;; <=

;; **
;;; What is interesting about this is that it exposes the internal random state of the `marsaglia-normal` to the inference engine.  This may or may not be a good idea depending on a number of issues.
;;; 
;;; Here is the Gaussian unknown mean example from the Anglican paper. With the internal uniform continuous draws exposed to inference.
;;; 
;;; 
;; **

;; @@
(defquery unknown-mean-internals-exposed [d] 
    (let [sigma (sqrt 2)
          mu (marsaglia-normal-cps 1 5)]
      
          (observe (normal mu sigma) 9)
          (observe (normal mu sigma) 8)

          (predict :mu mu)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-internals-exposed</span>","value":"#'marsaglia/unknown-mean-internals-exposed"}
;; <=

;; **
;;; And here is the same but with the internals hidden from inference.
;; **

;; @@
  (def data [9 8])
  (with-primitive-procedures [my-normal] 
    (defquery unknown-mean-internals-hidden [d] 
      (let [sigma (sqrt 2)
            mu (sample (my-normal 1 5))
            obsdist (my-normal mu sigma)]
              (map (fn [d] (observe obsdist d)) data)
              (predict :mu mu))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-internals-hidden</span>","value":"#'marsaglia/unknown-mean-internals-hidden"}
;; <=

;; **
;;; |And here are the results.  (green: internals exposed, blue: internals hidden)
;; **

;; @@
(plot/compose  
  (plot/list-plot 
     (->> (linspace 3 11 100)
          (map #(into []  
                      [% (exp (observe (my-normal 7.25 0.913) %))]))
          (into [])) :joined true)
  
     (->> (doquery :lmh unknown-mean-internals-exposed nil)
        (map get-predicts)
        (map :mu)
        (take 20000)
        (#(plot/histogram % :normalize :probability-density :bins 100 :color "#5A0")))
     (->> (doquery :lmh unknown-mean-internals-hidden nil)
        (map get-predicts)
        (map :mu)
        (take 20000)
        (#(plot/histogram % :normalize :probability-density :bins 100 :color "#05A"))))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"bottom":20,"top":10,"right":10,"left":50},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"848aafa0-eeb5-4d6c-a936-8b22594f99a7","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"848aafa0-eeb5-4d6c-a936-8b22594f99a7","field":"data.y"}}],"axes":[{"scale":"x","type":"x"},{"scale":"y","type":"y"}],"data":[{"name":"848aafa0-eeb5-4d6c-a936-8b22594f99a7","values":[{"x":3,"y":2.1120447273365065E-5},{"x":3.080808080808081,"y":3.06559212148127E-5},{"x":3.161616161616162,"y":4.417936572025371E-5},{"x":3.242424242424242,"y":6.321475027946064E-5},{"x":3.323232323232323,"y":8.980721358627321E-5},{"x":3.404040404040404,"y":1.2667702696868852E-4},{"x":3.484848484848485,"y":1.7741010279001163E-4},{"x":3.565656565656566,"y":2.4669064351566804E-4},{"x":3.646464646464646,"y":3.4058134267691864E-4},{"x":3.727272727272727,"y":4.6685592368091655E-4},{"x":3.808080808080808,"y":6.353876060507161E-4},{"x":3.888888888888889,"y":8.585951870717406E-4},{"x":3.96969696969697,"y":0.0011519456927384973},{"x":4.050505050505051,"y":0.0015345088793365367},{"x":4.131313131313131,"y":0.0020295541887882574},{"x":4.212121212121212,"y":0.0026651750689040605},{"x":4.292929292929293,"y":0.0034749189364212587},{"x":4.373737373737374,"y":0.004498393660516071},{"x":4.454545454545455,"y":0.0057818135718571565},{"x":4.535353535353535,"y":0.007378440084589371},{"x":4.616161616161616,"y":0.009348864619840636},{"x":4.696969696969697,"y":0.0117610753316202},{"x":4.777777777777778,"y":0.014690244956493105},{"x":4.858585858585859,"y":0.0182181757991257},{"x":4.939393939393939,"y":0.022432340295672155},{"x":5.02020202020202,"y":0.02742446256771582},{"x":5.101010101010101,"y":0.03328859853798022},{"x":5.181818181818182,"y":0.04011868992212774},{"x":5.262626262626263,"y":0.048005590790316216},{"x":5.343434343434343,"y":0.05703359402903087},{"x":5.424242424242424,"y":0.06727651805450008},{"x":5.505050505050505,"y":0.07879345013310377},{"x":5.585858585858586,"y":0.09162427973393426},{"x":5.666666666666667,"y":0.10578519109943506},{"x":5.747474747474747,"y":0.12126431595435049},{"x":5.828282828282828,"y":0.13801777208782148},{"x":5.909090909090909,"y":0.15596632858219608},{"x":5.98989898989899,"y":0.17499294115176633},{"x":6.070707070707071,"y":0.19494138936441785},{"x":6.151515151515152,"y":0.21561622021095458},{"x":6.232323232323232,"y":0.23678415932986338},{"x":6.313131313131313,"y":0.2581770931191938},{"x":6.393939393939394,"y":0.2794966541309653},{"x":6.474747474747475,"y":0.30042036190202076},{"x":6.555555555555556,"y":0.3206091861357449},{"x":6.636363636363636,"y":0.33971631411889075},{"x":6.717171717171717,"y":0.3573968250962097},{"x":6.797979797979798,"y":0.3733179067251942},{"x":6.878787878787879,"y":0.3871691979633977},{"x":6.95959595959596,"y":0.39867281319467224},{"x":7.04040404040404,"y":0.40759259718863483},{"x":7.121212121212121,"y":0.41374218111796457},{"x":7.202020202020202,"y":0.4169914560403278},{"x":7.282828282828283,"y":0.4172711498467348},{"x":7.363636363636364,"y":0.41457528280557543},{"x":7.444444444444444,"y":0.40896138012988537},{"x":7.525252525252525,"y":0.4005484310140701},{"x":7.606060606060606,"y":0.38951269527709476},{"x":7.686868686868687,"y":0.37608156401155074},{"x":7.767676767676768,"y":0.3605257728697965},{"x":7.848484848484848,"y":0.34315034022035634},{"x":7.929292929292929,"y":0.3242846531977055},{"x":8.01010101010101,"y":0.3042721501679745},{"x":8.090909090909092,"y":0.2834600477039632},{"x":8.171717171717171,"y":0.26218953498707503},{"x":8.252525252525253,"y":0.24078681146226066},{"x":8.333333333333332,"y":0.21955527874642172},{"x":8.414141414141413,"y":0.1987691203696934},{"x":8.494949494949495,"y":0.17866841856110108},{"x":8.575757575757576,"y":0.15945587167427858},{"x":8.656565656565657,"y":0.14129509430642737},{"x":8.737373737373737,"y":0.12431040927402966},{"x":8.818181818181818,"y":0.10858797993860228},{"x":8.8989898989899,"y":0.09417808531393819},{"x":8.97979797979798,"y":0.08109831009064292},{"x":9.06060606060606,"y":0.06933740716175898},{"x":9.141414141414142,"y":0.05885959036074949},{"x":9.222222222222221,"y":0.0496090280296045},{"x":9.303030303030303,"y":0.04151433122899048},{"x":9.383838383838384,"y":0.03449286106164318},{"x":9.464646464646465,"y":0.028454714800882783},{"x":9.545454545454545,"y":0.023306287533554286},{"x":9.626262626262626,"y":0.01895334239159247},{"x":9.707070707070708,"y":0.015303556149270606},{"x":9.787878787878787,"y":0.012268536504242653},{"x":9.868686868686869,"y":0.009765331768676515},{"x":9.94949494949495,"y":0.007717472504644725},{"x":10.03030303030303,"y":0.00605559782246243},{"x":10.11111111111111,"y":0.004717726961051387},{"x":10.19191919191919,"y":0.0036492399930358544},{"x":10.27272727272727,"y":0.0028026308238106633},{"x":10.35353535353535,"y":0.0021370919457381755},{"x":10.43434343434343,"y":0.0016179845341215383},{"x":10.51515151515152,"y":0.0012162402435766117},{"x":10.5959595959596,"y":9.077331960161564E-4},{"x":10.67676767676768,"y":6.726527337103154E-4},{"x":10.75757575757576,"y":4.948999958018433E-4},{"x":10.83838383838384,"y":3.615245829159397E-4},{"x":10.91919191919192,"y":2.622116977162102E-4},{"x":11,"y":1.888252794544033E-4}]},{"name":"74ac5cfa-92dc-46ab-92da-2c34abcee9d3","values":[{"x":3.4872638206209143,"y":0},{"x":3.553929178454841,"y":7.500147246574105E-4},{"x":3.6205945362887673,"y":0.0},{"x":3.6872598941226937,"y":0.0},{"x":3.75392525195662,"y":0.0},{"x":3.8205906097905467,"y":0.0},{"x":3.887255967624473,"y":0.0},{"x":3.9539213254583996,"y":0.0},{"x":4.020586683292326,"y":0.0},{"x":4.087252041126252,"y":0.001500029449314821},{"x":4.1539173989601785,"y":0.0},{"x":4.220582756794105,"y":0.0},{"x":4.2872481146280315,"y":0.004500088347944463},{"x":4.353913472461958,"y":0.0037500736232870526},{"x":4.420578830295884,"y":0.021000412290407496},{"x":4.487244188129811,"y":0.01575030921780562},{"x":4.553909545963737,"y":0.0142502797684908},{"x":4.620574903797664,"y":0.033750662609583475},{"x":4.68724026163159,"y":0.017250338667120443},{"x":4.753905619465517,"y":0.03150061843561124},{"x":4.820570977299443,"y":0.024750485913694546},{"x":4.88723633513337,"y":0.009750191420546337},{"x":4.953901692967296,"y":0.020250397565750086},{"x":5.020567050801223,"y":0.022500441739722314},{"x":5.087232408635149,"y":0.0502509865520465},{"x":5.1538977664690755,"y":0.04875095710273168},{"x":5.220563124303002,"y":0.06000117797259284},{"x":5.287228482136928,"y":0.06075119269725025},{"x":5.353893839970855,"y":0.02925057426163901},{"x":5.420559197804781,"y":0.034500677334240885},{"x":5.487224555638708,"y":0.04425086875478722},{"x":5.553889913472634,"y":0.030750603710953832},{"x":5.620555271306561,"y":0.06300123687122249},{"x":5.687220629140487,"y":0.062251222146565074},{"x":5.753885986974414,"y":0.07575148719039847},{"x":5.82055134480834,"y":0.14775290075750988},{"x":5.887216702642267,"y":0.10425204672738006},{"x":5.953882060476193,"y":0.07425145774108365},{"x":6.0205474183101195,"y":0.10125198782875042},{"x":6.087212776144046,"y":0.19125375478763967},{"x":6.1538781339779725,"y":0.20550403455613048},{"x":6.220543491811899,"y":0.155253048004084},{"x":6.287208849645825,"y":0.16200318052600068},{"x":6.353874207479752,"y":0.360007067835557},{"x":6.420539565313678,"y":0.18975372533832485},{"x":6.487204923147605,"y":0.30750603710953833},{"x":6.553870280981531,"y":0.2902556984424179},{"x":6.620535638815458,"y":0.268505271427353},{"x":6.687200996649384,"y":0.3067560223848809},{"x":6.753866354483311,"y":0.4710092470848538},{"x":6.820531712317237,"y":0.2752554039492697},{"x":6.887197070151164,"y":0.39750780406842756},{"x":6.95386242798509,"y":0.5025098655204651},{"x":7.0205277858190165,"y":0.35625699421227},{"x":7.087193143652943,"y":0.49350968882457613},{"x":7.153858501486869,"y":0.3802574654013071},{"x":7.220523859320796,"y":0.4125080985615758},{"x":7.287189217154722,"y":0.42375831943143694},{"x":7.353854574988649,"y":0.372757318154733},{"x":7.420519932822575,"y":0.5490107784492245},{"x":7.487185290656502,"y":0.37500736232870524},{"x":7.553850648490428,"y":0.5047599096944373},{"x":7.620516006324355,"y":0.5257603219848448},{"x":7.687181364158281,"y":0.5077599685930669},{"x":7.753846721992208,"y":0.3735073328793904},{"x":7.820512079826134,"y":0.36075708256021444},{"x":7.8871774376600605,"y":0.5160101305642985},{"x":7.953842795493987,"y":0.3810074801259645},{"x":8.020508153327913,"y":0.3427567291684366},{"x":8.08717351116184,"y":0.3427567291684366},{"x":8.153838868995766,"y":0.13350262098901908},{"x":8.220504226829693,"y":0.29475578679036235},{"x":8.28716958466362,"y":0.21075413762873235},{"x":8.353834942497546,"y":0.1695033277725748},{"x":8.420500300331472,"y":0.20400400510681566},{"x":8.487165658165399,"y":0.20175396093284342},{"x":8.553831015999325,"y":0.1725033866712044},{"x":8.620496373833252,"y":0.16800329832325997},{"x":8.687161731667178,"y":0.1567530774533988},{"x":8.753827089501105,"y":0.1485029154821673},{"x":8.820492447335031,"y":0.13875272406162095},{"x":8.887157805168957,"y":0.10950214979998193},{"x":8.953823163002884,"y":0.018750368116435264},{"x":9.02048852083681,"y":0.04425086875478722},{"x":9.087153878670737,"y":0.0022500441739722317},{"x":9.153819236504663,"y":0.017250338667120443},{"x":9.22048459433859,"y":0.0037500736232870526},{"x":9.287149952172516,"y":7.500147246574105E-4},{"x":9.353815310006443,"y":0.034500677334240885},{"x":9.42048066784037,"y":0.11775231177121345},{"x":9.487146025674296,"y":0.02700053008766678},{"x":9.553811383508222,"y":0.009750191420546337},{"x":9.620476741342149,"y":0.026250515363009368},{"x":9.687142099176075,"y":0.030750603710953832},{"x":9.753807457010002,"y":0.0},{"x":9.820472814843928,"y":0.0},{"x":9.887138172677854,"y":0.005250103072601874},{"x":9.953803530511781,"y":0.0},{"x":10.020468888345707,"y":0.033000647884926064},{"x":10.087134246179634,"y":0.0},{"x":10.15379960401356,"y":0.011250220869861157},{"x":10.220464961847487,"y":0}]},{"name":"5021ca23-0576-4752-a171-a5a5b7e0e1ce","values":[{"x":2.945716698191176,"y":0},{"x":3.0210359990171973,"y":0.003983042815187107},{"x":3.0963552998432187,"y":0.0},{"x":3.17167460066924,"y":0.0},{"x":3.2469939014952613,"y":0.0},{"x":3.3223132023212827,"y":0.0},{"x":3.397632503147304,"y":0.0},{"x":3.4729518039733254,"y":0.0},{"x":3.5482711047993467,"y":0.0},{"x":3.623590405625368,"y":0.0},{"x":3.6989097064513894,"y":0.0},{"x":3.7742290072774107,"y":0.0},{"x":3.849548308103432,"y":0.0},{"x":3.9248676089294534,"y":0.0},{"x":4.000186909755475,"y":0.0},{"x":4.075506210581496,"y":0.0},{"x":4.150825511407517,"y":0.002655361876791405},{"x":4.226144812233539,"y":0.003319202345989256},{"x":4.30146411305956,"y":0.015268330791550579},{"x":4.3767834138855815,"y":0.0},{"x":4.452102714711603,"y":0.0},{"x":4.527422015537624,"y":0.0},{"x":4.6027413163636455,"y":0.0},{"x":4.678060617189667,"y":0.0},{"x":4.753379918015688,"y":0.0},{"x":4.8286992188417095,"y":0.0},{"x":4.904018519667731,"y":0.0},{"x":4.979337820493752,"y":0.007302245161176364},{"x":5.0546571213197735,"y":0.05841796128941091},{"x":5.129976422145795,"y":0.006638404691978512},{"x":5.205295722971816,"y":0.0285451401755076},{"x":5.2806150237978375,"y":0.007302245161176364},{"x":5.355934324623859,"y":0.0},{"x":5.43125362544988,"y":0.029208980644705455},{"x":5.506572926275902,"y":0.00531072375358281},{"x":5.581892227101923,"y":0.003319202345989256},{"x":5.657211527927944,"y":0.12148280586320677},{"x":5.732530828753966,"y":0.07766933489614859},{"x":5.807850129579987,"y":0.04978803518983884},{"x":5.883169430406008,"y":0.03451970439828826},{"x":5.95848873123203,"y":0.11550824164042611},{"x":6.033808032058051,"y":0.01062144750716562},{"x":6.109127332884072,"y":0.11152519882523901},{"x":6.184446633710094,"y":0.2383187284420286},{"x":6.259765934536115,"y":0.4474284762393517},{"x":6.335085235362136,"y":0.20180750263614677},{"x":6.410404536188158,"y":0.3730783436891924},{"x":6.485723837014179,"y":0.29607284926224164},{"x":6.5610431378402,"y":0.10156759178727123},{"x":6.636362438666222,"y":0.1699431601146499},{"x":6.711681739492243,"y":0.4095895694950742},{"x":6.787001040318264,"y":0.2369910475036329},{"x":6.862320341144286,"y":0.5941372199320768},{"x":6.937639641970307,"y":0.5370469395810616},{"x":7.012958942796328,"y":0.32793719178373854},{"x":7.08827824362235,"y":0.46933521172288084},{"x":7.163597544448371,"y":1.2606330510067194},{"x":7.238916845274392,"y":0.7302245161176364},{"x":7.314236146100414,"y":0.6100693911928253},{"x":7.389555446926435,"y":1.02563352491068},{"x":7.464874747752456,"y":0.4899142662680142},{"x":7.540194048578478,"y":0.41224493137186563},{"x":7.615513349404499,"y":0.6664958310746426},{"x":7.69083265023052,"y":0.3491800867980697},{"x":7.766151951056542,"y":0.03584738533668397},{"x":7.841471251882563,"y":0.6731342357666211},{"x":7.9167905527085844,"y":0.0},{"x":7.992109853534606,"y":0.12081896539400892},{"x":8.067429154360626,"y":0.10156759178727123},{"x":8.142748455186647,"y":0.0},{"x":8.218067756012667,"y":0.0},{"x":8.293387056838688,"y":0.0},{"x":8.368706357664708,"y":0.08829078240331421},{"x":8.444025658490729,"y":0.6087417102544296},{"x":8.519344959316749,"y":0.0},{"x":8.59466426014277,"y":0.46136912609250663},{"x":8.66998356096879,"y":0.0},{"x":8.74530286179481,"y":0.0},{"x":8.82062216262083,"y":0.2515955378259856},{"x":8.895941463446851,"y":0.0},{"x":8.971260764272872,"y":0.24694865454160067},{"x":9.046580065098892,"y":0.0},{"x":9.121899365924913,"y":0.0},{"x":9.197218666750933,"y":0.004646883284384958},{"x":9.272537967576953,"y":0.0},{"x":9.347857268402974,"y":0.0},{"x":9.423176569228994,"y":0.0},{"x":9.498495870055015,"y":0.0},{"x":9.573815170881035,"y":0.0},{"x":9.649134471707056,"y":0.0},{"x":9.724453772533076,"y":0.0},{"x":9.799773073359097,"y":0.0},{"x":9.875092374185117,"y":0.0},{"x":9.950411675011138,"y":0.0},{"x":10.025730975837158,"y":0.0},{"x":10.101050276663178,"y":0.0},{"x":10.176369577489199,"y":0.0},{"x":10.25168887831522,"y":0.0},{"x":10.32700817914124,"y":0.02057905454513339},{"x":10.40232747996726,"y":0.0},{"x":10.47764678079328,"y":0.0},{"x":10.552966081619301,"y":0.023234416421924795},{"x":10.628285382445322,"y":0}]}],"marks":[{"type":"line","from":{"data":"848aafa0-eeb5-4d6c-a936-8b22594f99a7"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"74ac5cfa-92dc-46ab-92da-2c34abcee9d3"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"#5A0"},"fillOpacity":{"value":0.4},"stroke":{"value":"#5A0"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"5021ca23-0576-4752-a171-a5a5b7e0e1ce"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"#05A"},"fillOpacity":{"value":0.4},"stroke":{"value":"#05A"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:bottom 20, :top 10, :right 10, :left 50}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"848aafa0-eeb5-4d6c-a936-8b22594f99a7\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"848aafa0-eeb5-4d6c-a936-8b22594f99a7\", :field \"data.y\"}}], :axes [{:scale \"x\", :type \"x\"} {:scale \"y\", :type \"y\"}], :data ({:name \"848aafa0-eeb5-4d6c-a936-8b22594f99a7\", :values ({:x 3, :y 2.1120447273365065E-5} {:x 305/99, :y 3.06559212148127E-5} {:x 313/99, :y 4.417936572025371E-5} {:x 107/33, :y 6.321475027946064E-5} {:x 329/99, :y 8.980721358627321E-5} {:x 337/99, :y 1.2667702696868852E-4} {:x 115/33, :y 1.7741010279001163E-4} {:x 353/99, :y 2.4669064351566804E-4} {:x 361/99, :y 3.4058134267691864E-4} {:x 41/11, :y 4.6685592368091655E-4} {:x 377/99, :y 6.353876060507161E-4} {:x 35/9, :y 8.585951870717406E-4} {:x 131/33, :y 0.0011519456927384973} {:x 401/99, :y 0.0015345088793365367} {:x 409/99, :y 0.0020295541887882574} {:x 139/33, :y 0.0026651750689040605} {:x 425/99, :y 0.0034749189364212587} {:x 433/99, :y 0.004498393660516071} {:x 49/11, :y 0.0057818135718571565} {:x 449/99, :y 0.007378440084589371} {:x 457/99, :y 0.009348864619840636} {:x 155/33, :y 0.0117610753316202} {:x 43/9, :y 0.014690244956493105} {:x 481/99, :y 0.0182181757991257} {:x 163/33, :y 0.022432340295672155} {:x 497/99, :y 0.02742446256771582} {:x 505/99, :y 0.03328859853798022} {:x 57/11, :y 0.04011868992212774} {:x 521/99, :y 0.048005590790316216} {:x 529/99, :y 0.05703359402903087} {:x 179/33, :y 0.06727651805450008} {:x 545/99, :y 0.07879345013310377} {:x 553/99, :y 0.09162427973393426} {:x 17/3, :y 0.10578519109943506} {:x 569/99, :y 0.12126431595435049} {:x 577/99, :y 0.13801777208782148} {:x 65/11, :y 0.15596632858219608} {:x 593/99, :y 0.17499294115176633} {:x 601/99, :y 0.19494138936441785} {:x 203/33, :y 0.21561622021095458} {:x 617/99, :y 0.23678415932986338} {:x 625/99, :y 0.2581770931191938} {:x 211/33, :y 0.2794966541309653} {:x 641/99, :y 0.30042036190202076} {:x 59/9, :y 0.3206091861357449} {:x 73/11, :y 0.33971631411889075} {:x 665/99, :y 0.3573968250962097} {:x 673/99, :y 0.3733179067251942} {:x 227/33, :y 0.3871691979633977} {:x 689/99, :y 0.39867281319467224} {:x 697/99, :y 0.40759259718863483} {:x 235/33, :y 0.41374218111796457} {:x 713/99, :y 0.4169914560403278} {:x 721/99, :y 0.4172711498467348} {:x 81/11, :y 0.41457528280557543} {:x 67/9, :y 0.40896138012988537} {:x 745/99, :y 0.4005484310140701} {:x 251/33, :y 0.38951269527709476} {:x 761/99, :y 0.37608156401155074} {:x 769/99, :y 0.3605257728697965} {:x 259/33, :y 0.34315034022035634} {:x 785/99, :y 0.3242846531977055} {:x 793/99, :y 0.3042721501679745} {:x 89/11, :y 0.2834600477039632} {:x 809/99, :y 0.26218953498707503} {:x 817/99, :y 0.24078681146226066} {:x 25/3, :y 0.21955527874642172} {:x 833/99, :y 0.1987691203696934} {:x 841/99, :y 0.17866841856110108} {:x 283/33, :y 0.15945587167427858} {:x 857/99, :y 0.14129509430642737} {:x 865/99, :y 0.12431040927402966} {:x 97/11, :y 0.10858797993860228} {:x 881/99, :y 0.09417808531393819} {:x 889/99, :y 0.08109831009064292} {:x 299/33, :y 0.06933740716175898} {:x 905/99, :y 0.05885959036074949} {:x 83/9, :y 0.0496090280296045} {:x 307/33, :y 0.04151433122899048} {:x 929/99, :y 0.03449286106164318} {:x 937/99, :y 0.028454714800882783} {:x 105/11, :y 0.023306287533554286} {:x 953/99, :y 0.01895334239159247} {:x 961/99, :y 0.015303556149270606} {:x 323/33, :y 0.012268536504242653} {:x 977/99, :y 0.009765331768676515} {:x 985/99, :y 0.007717472504644725} {:x 331/33, :y 0.00605559782246243} {:x 91/9, :y 0.004717726961051387} {:x 1009/99, :y 0.0036492399930358544} {:x 113/11, :y 0.0028026308238106633} {:x 1025/99, :y 0.0021370919457381755} {:x 1033/99, :y 0.0016179845341215383} {:x 347/33, :y 0.0012162402435766117} {:x 1049/99, :y 9.077331960161564E-4} {:x 1057/99, :y 6.726527337103154E-4} {:x 355/33, :y 4.948999958018433E-4} {:x 1073/99, :y 3.615245829159397E-4} {:x 1081/99, :y 2.622116977162102E-4} {:x 11N, :y 1.888252794544033E-4})} {:name \"74ac5cfa-92dc-46ab-92da-2c34abcee9d3\", :values ({:x 3.4872638206209143, :y 0} {:x 3.553929178454841, :y 7.500147246574105E-4} {:x 3.6205945362887673, :y 0.0} {:x 3.6872598941226937, :y 0.0} {:x 3.75392525195662, :y 0.0} {:x 3.8205906097905467, :y 0.0} {:x 3.887255967624473, :y 0.0} {:x 3.9539213254583996, :y 0.0} {:x 4.020586683292326, :y 0.0} {:x 4.087252041126252, :y 0.001500029449314821} {:x 4.1539173989601785, :y 0.0} {:x 4.220582756794105, :y 0.0} {:x 4.2872481146280315, :y 0.004500088347944463} {:x 4.353913472461958, :y 0.0037500736232870526} {:x 4.420578830295884, :y 0.021000412290407496} {:x 4.487244188129811, :y 0.01575030921780562} {:x 4.553909545963737, :y 0.0142502797684908} {:x 4.620574903797664, :y 0.033750662609583475} {:x 4.68724026163159, :y 0.017250338667120443} {:x 4.753905619465517, :y 0.03150061843561124} {:x 4.820570977299443, :y 0.024750485913694546} {:x 4.88723633513337, :y 0.009750191420546337} {:x 4.953901692967296, :y 0.020250397565750086} {:x 5.020567050801223, :y 0.022500441739722314} {:x 5.087232408635149, :y 0.0502509865520465} {:x 5.1538977664690755, :y 0.04875095710273168} {:x 5.220563124303002, :y 0.06000117797259284} {:x 5.287228482136928, :y 0.06075119269725025} {:x 5.353893839970855, :y 0.02925057426163901} {:x 5.420559197804781, :y 0.034500677334240885} {:x 5.487224555638708, :y 0.04425086875478722} {:x 5.553889913472634, :y 0.030750603710953832} {:x 5.620555271306561, :y 0.06300123687122249} {:x 5.687220629140487, :y 0.062251222146565074} {:x 5.753885986974414, :y 0.07575148719039847} {:x 5.82055134480834, :y 0.14775290075750988} {:x 5.887216702642267, :y 0.10425204672738006} {:x 5.953882060476193, :y 0.07425145774108365} {:x 6.0205474183101195, :y 0.10125198782875042} {:x 6.087212776144046, :y 0.19125375478763967} {:x 6.1538781339779725, :y 0.20550403455613048} {:x 6.220543491811899, :y 0.155253048004084} {:x 6.287208849645825, :y 0.16200318052600068} {:x 6.353874207479752, :y 0.360007067835557} {:x 6.420539565313678, :y 0.18975372533832485} {:x 6.487204923147605, :y 0.30750603710953833} {:x 6.553870280981531, :y 0.2902556984424179} {:x 6.620535638815458, :y 0.268505271427353} {:x 6.687200996649384, :y 0.3067560223848809} {:x 6.753866354483311, :y 0.4710092470848538} {:x 6.820531712317237, :y 0.2752554039492697} {:x 6.887197070151164, :y 0.39750780406842756} {:x 6.95386242798509, :y 0.5025098655204651} {:x 7.0205277858190165, :y 0.35625699421227} {:x 7.087193143652943, :y 0.49350968882457613} {:x 7.153858501486869, :y 0.3802574654013071} {:x 7.220523859320796, :y 0.4125080985615758} {:x 7.287189217154722, :y 0.42375831943143694} {:x 7.353854574988649, :y 0.372757318154733} {:x 7.420519932822575, :y 0.5490107784492245} {:x 7.487185290656502, :y 0.37500736232870524} {:x 7.553850648490428, :y 0.5047599096944373} {:x 7.620516006324355, :y 0.5257603219848448} {:x 7.687181364158281, :y 0.5077599685930669} {:x 7.753846721992208, :y 0.3735073328793904} {:x 7.820512079826134, :y 0.36075708256021444} {:x 7.8871774376600605, :y 0.5160101305642985} {:x 7.953842795493987, :y 0.3810074801259645} {:x 8.020508153327913, :y 0.3427567291684366} {:x 8.08717351116184, :y 0.3427567291684366} {:x 8.153838868995766, :y 0.13350262098901908} {:x 8.220504226829693, :y 0.29475578679036235} {:x 8.28716958466362, :y 0.21075413762873235} {:x 8.353834942497546, :y 0.1695033277725748} {:x 8.420500300331472, :y 0.20400400510681566} {:x 8.487165658165399, :y 0.20175396093284342} {:x 8.553831015999325, :y 0.1725033866712044} {:x 8.620496373833252, :y 0.16800329832325997} {:x 8.687161731667178, :y 0.1567530774533988} {:x 8.753827089501105, :y 0.1485029154821673} {:x 8.820492447335031, :y 0.13875272406162095} {:x 8.887157805168957, :y 0.10950214979998193} {:x 8.953823163002884, :y 0.018750368116435264} {:x 9.02048852083681, :y 0.04425086875478722} {:x 9.087153878670737, :y 0.0022500441739722317} {:x 9.153819236504663, :y 0.017250338667120443} {:x 9.22048459433859, :y 0.0037500736232870526} {:x 9.287149952172516, :y 7.500147246574105E-4} {:x 9.353815310006443, :y 0.034500677334240885} {:x 9.42048066784037, :y 0.11775231177121345} {:x 9.487146025674296, :y 0.02700053008766678} {:x 9.553811383508222, :y 0.009750191420546337} {:x 9.620476741342149, :y 0.026250515363009368} {:x 9.687142099176075, :y 0.030750603710953832} {:x 9.753807457010002, :y 0.0} {:x 9.820472814843928, :y 0.0} {:x 9.887138172677854, :y 0.005250103072601874} {:x 9.953803530511781, :y 0.0} {:x 10.020468888345707, :y 0.033000647884926064} {:x 10.087134246179634, :y 0.0} {:x 10.15379960401356, :y 0.011250220869861157} {:x 10.220464961847487, :y 0})} {:name \"5021ca23-0576-4752-a171-a5a5b7e0e1ce\", :values ({:x 2.945716698191176, :y 0} {:x 3.0210359990171973, :y 0.003983042815187107} {:x 3.0963552998432187, :y 0.0} {:x 3.17167460066924, :y 0.0} {:x 3.2469939014952613, :y 0.0} {:x 3.3223132023212827, :y 0.0} {:x 3.397632503147304, :y 0.0} {:x 3.4729518039733254, :y 0.0} {:x 3.5482711047993467, :y 0.0} {:x 3.623590405625368, :y 0.0} {:x 3.6989097064513894, :y 0.0} {:x 3.7742290072774107, :y 0.0} {:x 3.849548308103432, :y 0.0} {:x 3.9248676089294534, :y 0.0} {:x 4.000186909755475, :y 0.0} {:x 4.075506210581496, :y 0.0} {:x 4.150825511407517, :y 0.002655361876791405} {:x 4.226144812233539, :y 0.003319202345989256} {:x 4.30146411305956, :y 0.015268330791550579} {:x 4.3767834138855815, :y 0.0} {:x 4.452102714711603, :y 0.0} {:x 4.527422015537624, :y 0.0} {:x 4.6027413163636455, :y 0.0} {:x 4.678060617189667, :y 0.0} {:x 4.753379918015688, :y 0.0} {:x 4.8286992188417095, :y 0.0} {:x 4.904018519667731, :y 0.0} {:x 4.979337820493752, :y 0.007302245161176364} {:x 5.0546571213197735, :y 0.05841796128941091} {:x 5.129976422145795, :y 0.006638404691978512} {:x 5.205295722971816, :y 0.0285451401755076} {:x 5.2806150237978375, :y 0.007302245161176364} {:x 5.355934324623859, :y 0.0} {:x 5.43125362544988, :y 0.029208980644705455} {:x 5.506572926275902, :y 0.00531072375358281} {:x 5.581892227101923, :y 0.003319202345989256} {:x 5.657211527927944, :y 0.12148280586320677} {:x 5.732530828753966, :y 0.07766933489614859} {:x 5.807850129579987, :y 0.04978803518983884} {:x 5.883169430406008, :y 0.03451970439828826} {:x 5.95848873123203, :y 0.11550824164042611} {:x 6.033808032058051, :y 0.01062144750716562} {:x 6.109127332884072, :y 0.11152519882523901} {:x 6.184446633710094, :y 0.2383187284420286} {:x 6.259765934536115, :y 0.4474284762393517} {:x 6.335085235362136, :y 0.20180750263614677} {:x 6.410404536188158, :y 0.3730783436891924} {:x 6.485723837014179, :y 0.29607284926224164} {:x 6.5610431378402, :y 0.10156759178727123} {:x 6.636362438666222, :y 0.1699431601146499} {:x 6.711681739492243, :y 0.4095895694950742} {:x 6.787001040318264, :y 0.2369910475036329} {:x 6.862320341144286, :y 0.5941372199320768} {:x 6.937639641970307, :y 0.5370469395810616} {:x 7.012958942796328, :y 0.32793719178373854} {:x 7.08827824362235, :y 0.46933521172288084} {:x 7.163597544448371, :y 1.2606330510067194} {:x 7.238916845274392, :y 0.7302245161176364} {:x 7.314236146100414, :y 0.6100693911928253} {:x 7.389555446926435, :y 1.02563352491068} {:x 7.464874747752456, :y 0.4899142662680142} {:x 7.540194048578478, :y 0.41224493137186563} {:x 7.615513349404499, :y 0.6664958310746426} {:x 7.69083265023052, :y 0.3491800867980697} {:x 7.766151951056542, :y 0.03584738533668397} {:x 7.841471251882563, :y 0.6731342357666211} {:x 7.9167905527085844, :y 0.0} {:x 7.992109853534606, :y 0.12081896539400892} {:x 8.067429154360626, :y 0.10156759178727123} {:x 8.142748455186647, :y 0.0} {:x 8.218067756012667, :y 0.0} {:x 8.293387056838688, :y 0.0} {:x 8.368706357664708, :y 0.08829078240331421} {:x 8.444025658490729, :y 0.6087417102544296} {:x 8.519344959316749, :y 0.0} {:x 8.59466426014277, :y 0.46136912609250663} {:x 8.66998356096879, :y 0.0} {:x 8.74530286179481, :y 0.0} {:x 8.82062216262083, :y 0.2515955378259856} {:x 8.895941463446851, :y 0.0} {:x 8.971260764272872, :y 0.24694865454160067} {:x 9.046580065098892, :y 0.0} {:x 9.121899365924913, :y 0.0} {:x 9.197218666750933, :y 0.004646883284384958} {:x 9.272537967576953, :y 0.0} {:x 9.347857268402974, :y 0.0} {:x 9.423176569228994, :y 0.0} {:x 9.498495870055015, :y 0.0} {:x 9.573815170881035, :y 0.0} {:x 9.649134471707056, :y 0.0} {:x 9.724453772533076, :y 0.0} {:x 9.799773073359097, :y 0.0} {:x 9.875092374185117, :y 0.0} {:x 9.950411675011138, :y 0.0} {:x 10.025730975837158, :y 0.0} {:x 10.101050276663178, :y 0.0} {:x 10.176369577489199, :y 0.0} {:x 10.25168887831522, :y 0.0} {:x 10.32700817914124, :y 0.02057905454513339} {:x 10.40232747996726, :y 0.0} {:x 10.47764678079328, :y 0.0} {:x 10.552966081619301, :y 0.023234416421924795} {:x 10.628285382445322, :y 0})}), :marks ({:type \"line\", :from {:data \"848aafa0-eeb5-4d6c-a936-8b22594f99a7\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"74ac5cfa-92dc-46ab-92da-2c34abcee9d3\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"#5A0\"}, :fillOpacity {:value 0.4}, :stroke {:value \"#5A0\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"5021ca23-0576-4752-a171-a5a5b7e0e1ce\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"#05A\"}, :fillOpacity {:value 0.4}, :stroke {:value \"#05A\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; **
;;; Which both result in query results near the analytical posterior of $$\mathrm{Normal}(7.25,.913^2)$$
;; **

;; @@
  {:internals-exposed (->> (doquery :lmh unknown-mean-internals-exposed nil)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(/ (reduce + %) (count %))))}
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:internals-exposed</span>","value":":internals-exposed"},{"type":"html","content":"<span class='clj-double'>7.222247612674517</span>","value":"7.222247612674517"}],"value":"[:internals-exposed 7.222247612674517]"}],"value":"{:internals-exposed 7.222247612674517}"}
;; <=

;; @@
  {:internals-hidden (->> (doquery :lmh unknown-mean-internals-hidden nil)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(/ (reduce + %) (count %))))}
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:internals-hidden</span>","value":":internals-hidden"},{"type":"html","content":"<span class='clj-double'>7.728521882403297</span>","value":"7.728521882403297"}],"value":"[:internals-hidden 7.728521882403297]"}],"value":"{:internals-hidden 7.728521882403297}"}
;; <=
