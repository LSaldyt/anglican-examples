;; gorilla-repl.fileformat = 1

;; **
;;; # Marsaglia
;;; 
;;; In probabilistic programming systems like Anglican that support _continuous_ variables, recursion, and branching on nondeterminism it is possible to write procedures in the language itself that sample from distributions with uncountable support.  Another way of saying this is that we can denote constructive definitions of distribution over uncountable support and sample from the same.
;; **

;; @@
(ns marsaglia
  (:require [gorilla-plot.core :as plot])
  (:use clojure.repl
        [anglican core runtime emit [state :only [get-predicts]]] 
        [clojure.string :only (join split blank?)]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; We can generate from a normal distribution in a number of ways.  A canonical method is to use the Marsaglia algorithm.
;; **

;; @@
(defn marsaglia-normal [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal mean var))))
     
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal</span>","value":"#'marsaglia/marsaglia-normal"}
;; <=

;; **
;;; We can check that this generator produces a sample distribution that is in accordance with our understanding of the normal distribution, noting that a huge part of our understanding of the normal distribution is that we know how to compute the (log) density of a return value from from the marsaglia-normal procedure.
;; **

;; @@
(defn linspace [min max n]
   (let [step (/ (- max min) (dec n))] 
      (range min (+ max step) step)))

(def pi java.lang.Math/PI)
(defn normal-lnpdf
  "Log probability density of a sample x drawn from a univariate normal with
  known mean and standard deviation"
  [x mean std]
  (let [dx (- x mean)
        var (* std std)]
    (* -0.5
       (+ (log (* 2 (* pi var)))
          (/ (* dx dx) var)))))


(plot/compose  
  (plot/list-plot 
     (->> (linspace -5 10 100)
          (map #(into []  
                      [% (exp (normal-lnpdf % 2 2))]))
          (into [])) :joined true)
  
  (plot/histogram 
    (repeatedly 10000 
       (partial marsaglia-normal 2 4)) 
       :normalise :probability-density :bins 100))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"bottom":20,"top":10,"right":10,"left":50},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"0abba31a-a623-4bff-b761-1d8f1fefcb90","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"0abba31a-a623-4bff-b761-1d8f1fefcb90","field":"data.y"}}],"axes":[{"scale":"x","type":"x"},{"scale":"y","type":"y"}],"data":[{"name":"0abba31a-a623-4bff-b761-1d8f1fefcb90","values":[{"x":-5,"y":4.3634134752288024E-4},{"x":-4.848484848484848,"y":5.671970386513821E-4},{"x":-4.696969696969697,"y":7.330760541955561E-4},{"x":-4.545454545454545,"y":9.42044905076907E-4},{"x":-4.393939393939394,"y":0.0012036540160990396},{"x":-4.242424242424242,"y":0.0015291117517670808},{"x":-4.090909090909091,"y":0.001931453582514972},{"x":-3.939393939393939,"y":0.0024256984882430987},{"x":-3.787878787878788,"y":0.0030289831142058456},{"x":-3.636363636363636,"y":0.0037606626743546595},{"x":-3.484848484848485,"y":0.004642366243399356},{"x":-3.333333333333333,"y":0.0056979930118987235},{"x":-3.181818181818182,"y":0.0069536354318799525},{"x":-3.03030303030303,"y":0.008437415093311126},{"x":-2.878787878787879,"y":0.010179217781743341},{"x":-2.727272727272727,"y":0.01221031560013476},{"x":-2.575757575757576,"y":0.014562866395343413},{"x":-2.424242424242424,"y":0.01726928407836528},{"x":-2.272727272727273,"y":0.02036147778541647},{"x":-2.121212121212121,"y":0.023869963153426765},{"x":-1.96969696969697,"y":0.02782285516898323},{"x":-1.818181818181818,"y":0.032244758910466395},{"x":-1.666666666666667,"y":0.03715558177949653},{"x":-1.515151515151515,"y":0.04256929817839459},{"x":-1.363636363636364,"y":0.04849270464169628},{"x":-1.212121212121212,"y":0.05492420973253507},{"x":-1.060606060606061,"y":0.06185270810597594},{"x":-0.9090909090909091,"y":0.06925659156197403},{"x":-0.7575757575757576,"y":0.07710295123647007},{"x":-0.6060606060606061,"y":0.08534702395452404},{"x":-0.4545454545454545,"y":0.09393193193992498},{"x":-0.303030303030303,"y":0.10278875841821113},{"x":-0.1515151515151515,"y":0.11183699219670964},{"x":0,"y":0.12098536225957167},{"x":0.1515151515151515,"y":0.13013306915798126},{"x":0.303030303030303,"y":0.1391714040558564},{"x":0.4545454545454545,"y":0.14798572940993074},{"x":0.6060606060606061,"y":0.15645777823895984},{"x":0.7575757575757576,"y":0.1644682126638791},{"x":0.9090909090909091,"y":0.17189936779597245},{"x":1.060606060606061,"y":0.1786380949957625},{"x":1.212121212121212,"y":0.1845786098098487},{"x":1.363636363636364,"y":0.18962524515457918},{"x":1.515151515151515,"y":0.19369500999336653},{"x":1.666666666666667,"y":0.19671985805096995},{"x":1.818181818181818,"y":0.19864857996587085},{"x":1.96969696969697,"y":0.1994482453783368},{"x":2.121212121212121,"y":0.1991051382113847},{"x":2.272727272727273,"y":0.19762514802646214},{"x":2.424242424242424,"y":0.1950336018506434},{"x":2.575757575757576,"y":0.19137454318543307},{"x":2.727272727272727,"y":0.1867094868769894},{"x":2.878787878787879,"y":0.18111569903330255},{"x":3.03030303030303,"y":0.1746840691863272},{"x":3.181818181818182,"y":0.16751665654118497},{"x":3.333333333333333,"y":0.1597240027611761},{"x":3.484848484848485,"y":0.15142230988016647},{"x":3.636363636363636,"y":0.14273058344920247},{"x":3.787878787878788,"y":0.13376783801223838},{"x":3.939393939393939,"y":0.12465045481480101},{"x":4.090909090909091,"y":0.11548977084320669},{"x":4.242424242424242,"y":0.1063899646054096},{"x":4.393939393939394,"y":0.09744628834948768},{"x":4.545454545454545,"y":0.08874367958231379},{"x":4.696969696969697,"y":0.08035576770889953},{"x":4.848484848484848,"y":0.07234427521687625},{"x":5,"y":0.06475879783294586},{"x":5.151515151515152,"y":0.05763693509221288},{"x":5.303030303030303,"y":0.051004732236744024},{"x":5.454545454545455,"y":0.04487738657066214},{"x":5.606060606060606,"y":0.03926016644494569},{"x":5.757575757575758,"y":0.03414948886235444},{"x":5.909090909090909,"y":0.02953410207628975},{"x":6.060606060606061,"y":0.025396322187902023},{"x":6.212121212121212,"y":0.02171327722262099},{"x":6.363636363636364,"y":0.0184581180414643},{"x":6.515151515151515,"y":0.015601162248989789},{"x":6.666666666666667,"y":0.013110944546854752},{"x":6.818181818181818,"y":0.01095515433554187},{"x":6.96969696969697,"y":0.009101448429106639},{"x":7.121212121212121,"y":0.007518133229683001},{"x":7.272727272727273,"y":0.006174716395760555},{"x":7.424242424242424,"y":0.005042332792223683},{"x":7.575757575757576,"y":0.004094053263393624},{"x":7.727272727272727,"y":0.0033050875186944255},{"x":7.878787878787879,"y":0.002652894212643802},{"x":8.03030303030303,"y":0.002117212225924384},{"x":8.181818181818182,"y":0.0016800273299080965},{"x":8.333333333333332,"y":0.0013254879772150497},{"x":8.484848484848484,"y":0.0010397830454919879},{"x":8.636363636363637,"y":8.10993107200834E-4},{"x":8.787878787878787,"y":6.289253312080865E-4},{"x":8.93939393939394,"y":4.849405535559764E-4},{"x":9.090909090909092,"y":3.7177947793890046E-4},{"x":9.242424242424242,"y":2.833934545377709E-4},{"x":9.393939393939394,"y":2.1478389305454535E-4},{"x":9.545454545454545,"y":1.618531280464772E-4},{"x":9.696969696969697,"y":1.212684920196218E-4},{"x":9.848484848484848,"y":9.034047084076489E-5},{"x":10,"y":6.691511288244271E-5}]},{"name":"4ff6c03c-ad50-4947-9d08-e8c2cb958d64","values":[{"x":-5.324750349872502,"y":0},{"x":-5.1754624014524895,"y":6.698464347480738E-4},{"x":-5.026174453032477,"y":0.0},{"x":-4.876886504612464,"y":0.0},{"x":-4.727598556192451,"y":6.698464347480738E-4},{"x":-4.578310607772438,"y":6.698464347480738E-4},{"x":-4.429022659352425,"y":0.002679385738992295},{"x":-4.279734710932412,"y":0.0013396928694961476},{"x":-4.130446762512399,"y":6.698464347480738E-4},{"x":-3.981158814092386,"y":0.003349232173740369},{"x":-3.8318708656723732,"y":0.0020095393042442213},{"x":-3.6825829172523603,"y":0.003349232173740369},{"x":-3.5332949688323474,"y":0.002679385738992295},{"x":-3.3840070204123345,"y":0.0013396928694961476},{"x":-3.2347190719923216,"y":0.009377850086473034},{"x":-3.0854311235723086,"y":0.004688925043236517},{"x":-2.9361431751522957,"y":0.00870800365172496},{"x":-2.786855226732283,"y":0.0073683107822288115},{"x":-2.63756727831227,"y":0.014736621564457623},{"x":-2.488279329892257,"y":0.01741600730344992},{"x":-2.338991381472244,"y":0.01607631443395377},{"x":-2.189703433052231,"y":0.012057235825465328},{"x":-2.0404154846322182,"y":0.01942554660769414},{"x":-1.8911275362122053,"y":0.01942554660769414},{"x":-1.7418395877921924,"y":0.037511400345892135},{"x":-1.5925516393721795,"y":0.03617170747639598},{"x":-1.4432636909521666,"y":0.050238482606105535},{"x":-1.2939757425321536,"y":0.056267100518838195},{"x":-1.1446877941121407,"y":0.059616332692578565},{"x":-0.9953998456921278,"y":0.06832433634430353},{"x":-0.8461118972721149,"y":0.06430525773581508},{"x":-0.696823948852102,"y":0.08038157216976885},{"x":-0.547536000432089,"y":0.08373080434350923},{"x":-0.39824805201207614,"y":0.08105141860451692},{"x":-0.2489601035920632,"y":0.09846742590796685},{"x":-0.09967215517205025,"y":0.10181665808170721},{"x":0.0496157932479627,"y":0.11320404747242448},{"x":0.19890374166797564,"y":0.1379883655581032},{"x":0.34819169008798856,"y":0.13530897981911091},{"x":0.4974796385080015,"y":0.14669636920982815},{"x":0.6467675869280144,"y":0.15004560138356854},{"x":0.7960555353480273,"y":0.15473452642680505},{"x":0.9453434837680402,"y":0.17750930520823954},{"x":1.0946314321880533,"y":0.17549976590399533},{"x":1.2439193806080662,"y":0.19492531251168949},{"x":1.393207329028079,"y":0.20564285546765865},{"x":1.542495277448092,"y":0.19425546607694139},{"x":1.691783225868105,"y":0.19291577320744524},{"x":1.8410711742881178,"y":0.20095393042442214},{"x":1.9903591227081308,"y":0.18219823025147608},{"x":2.139647071128144,"y":0.20296346972866636},{"x":2.288935019548157,"y":0.20497300903291057},{"x":2.4382229679681697,"y":0.17817915164298762},{"x":2.5875109163881826,"y":0.1935856196421933},{"x":2.7367988648081956,"y":0.18018869094723186},{"x":2.8860868132282085,"y":0.1868871552947126},{"x":3.0353747616482214,"y":0.19425546607694139},{"x":3.1846627100682343,"y":0.17282038016500303},{"x":3.3339506584882472,"y":0.15741391216579734},{"x":3.48323860690826,"y":0.15540437286155312},{"x":3.632526555328273,"y":0.13731851912335513},{"x":3.781814503748286,"y":0.13932805842759935},{"x":3.931102452168299,"y":0.1332994405148667},{"x":4.080390400588312,"y":0.13062005477587438},{"x":4.229678349008325,"y":0.09913727234271492},{"x":4.378966297428338,"y":0.09913727234271492},{"x":4.528254245848351,"y":0.099807118777463},{"x":4.677542194268364,"y":0.09846742590796685},{"x":4.826830142688377,"y":0.08373080434350923},{"x":4.97611809110839,"y":0.06497510417056315},{"x":5.125406039528403,"y":0.06162587199682279},{"x":5.274693987948416,"y":0.05157817547560168},{"x":5.4239819363684285,"y":0.03818124678064021},{"x":5.573269884788441,"y":0.04621940399761709},{"x":5.722557833208454,"y":0.03617170747639598},{"x":5.871845781628467,"y":0.034162168172151765},{"x":6.02113373004848,"y":0.03014308956366332},{"x":6.170421678468493,"y":0.022104932346686434},{"x":6.319709626888506,"y":0.024114471650930655},{"x":6.468997575308519,"y":0.01808585373819799},{"x":6.618285523728532,"y":0.018755700172946067},{"x":6.767573472148545,"y":0.013396928694961476},{"x":6.916861420568558,"y":0.01607631443395377},{"x":7.066149368988571,"y":0.008038157216976885},{"x":7.2154373174085835,"y":0.012057235825465328},{"x":7.364725265828596,"y":0.0013396928694961476},{"x":7.514013214248609,"y":0.006698464347480738},{"x":7.663301162668622,"y":0.003349232173740369},{"x":7.812589111088635,"y":0.003349232173740369},{"x":7.961877059508648,"y":0.002679385738992295},{"x":8.111165007928662,"y":0.002679385738992295},{"x":8.260452956348676,"y":0.0020095393042442213},{"x":8.40974090476869,"y":0.0},{"x":8.559028853188703,"y":6.698464347480738E-4},{"x":8.708316801608717,"y":0.0},{"x":8.857604750028731,"y":0.0},{"x":9.006892698448745,"y":6.698464347480738E-4},{"x":9.156180646868759,"y":0.0013396928694961476},{"x":9.305468595288772,"y":0.0},{"x":9.454756543708786,"y":6.698464347480738E-4},{"x":9.6040444921288,"y":0.0013396928694961476},{"x":9.753332440548814,"y":0}]}],"marks":[{"type":"line","from":{"data":"0abba31a-a623-4bff-b761-1d8f1fefcb90"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"4ff6c03c-ad50-4947-9d08-e8c2cb958d64"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:bottom 20, :top 10, :right 10, :left 50}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"0abba31a-a623-4bff-b761-1d8f1fefcb90\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"0abba31a-a623-4bff-b761-1d8f1fefcb90\", :field \"data.y\"}}], :axes [{:scale \"x\", :type \"x\"} {:scale \"y\", :type \"y\"}], :data ({:name \"0abba31a-a623-4bff-b761-1d8f1fefcb90\", :values ({:x -5, :y 4.3634134752288024E-4} {:x -160/33, :y 5.671970386513821E-4} {:x -155/33, :y 7.330760541955561E-4} {:x -50/11, :y 9.42044905076907E-4} {:x -145/33, :y 0.0012036540160990396} {:x -140/33, :y 0.0015291117517670808} {:x -45/11, :y 0.001931453582514972} {:x -130/33, :y 0.0024256984882430987} {:x -125/33, :y 0.0030289831142058456} {:x -40/11, :y 0.0037606626743546595} {:x -115/33, :y 0.004642366243399356} {:x -10/3, :y 0.0056979930118987235} {:x -35/11, :y 0.0069536354318799525} {:x -100/33, :y 0.008437415093311126} {:x -95/33, :y 0.010179217781743341} {:x -30/11, :y 0.01221031560013476} {:x -85/33, :y 0.014562866395343413} {:x -80/33, :y 0.01726928407836528} {:x -25/11, :y 0.02036147778541647} {:x -70/33, :y 0.023869963153426765} {:x -65/33, :y 0.02782285516898323} {:x -20/11, :y 0.032244758910466395} {:x -5/3, :y 0.03715558177949653} {:x -50/33, :y 0.04256929817839459} {:x -15/11, :y 0.04849270464169628} {:x -40/33, :y 0.05492420973253507} {:x -35/33, :y 0.06185270810597594} {:x -10/11, :y 0.06925659156197403} {:x -25/33, :y 0.07710295123647007} {:x -20/33, :y 0.08534702395452404} {:x -5/11, :y 0.09393193193992498} {:x -10/33, :y 0.10278875841821113} {:x -5/33, :y 0.11183699219670964} {:x 0N, :y 0.12098536225957167} {:x 5/33, :y 0.13013306915798126} {:x 10/33, :y 0.1391714040558564} {:x 5/11, :y 0.14798572940993074} {:x 20/33, :y 0.15645777823895984} {:x 25/33, :y 0.1644682126638791} {:x 10/11, :y 0.17189936779597245} {:x 35/33, :y 0.1786380949957625} {:x 40/33, :y 0.1845786098098487} {:x 15/11, :y 0.18962524515457918} {:x 50/33, :y 0.19369500999336653} {:x 5/3, :y 0.19671985805096995} {:x 20/11, :y 0.19864857996587085} {:x 65/33, :y 0.1994482453783368} {:x 70/33, :y 0.1991051382113847} {:x 25/11, :y 0.19762514802646214} {:x 80/33, :y 0.1950336018506434} {:x 85/33, :y 0.19137454318543307} {:x 30/11, :y 0.1867094868769894} {:x 95/33, :y 0.18111569903330255} {:x 100/33, :y 0.1746840691863272} {:x 35/11, :y 0.16751665654118497} {:x 10/3, :y 0.1597240027611761} {:x 115/33, :y 0.15142230988016647} {:x 40/11, :y 0.14273058344920247} {:x 125/33, :y 0.13376783801223838} {:x 130/33, :y 0.12465045481480101} {:x 45/11, :y 0.11548977084320669} {:x 140/33, :y 0.1063899646054096} {:x 145/33, :y 0.09744628834948768} {:x 50/11, :y 0.08874367958231379} {:x 155/33, :y 0.08035576770889953} {:x 160/33, :y 0.07234427521687625} {:x 5N, :y 0.06475879783294586} {:x 170/33, :y 0.05763693509221288} {:x 175/33, :y 0.051004732236744024} {:x 60/11, :y 0.04487738657066214} {:x 185/33, :y 0.03926016644494569} {:x 190/33, :y 0.03414948886235444} {:x 65/11, :y 0.02953410207628975} {:x 200/33, :y 0.025396322187902023} {:x 205/33, :y 0.02171327722262099} {:x 70/11, :y 0.0184581180414643} {:x 215/33, :y 0.015601162248989789} {:x 20/3, :y 0.013110944546854752} {:x 75/11, :y 0.01095515433554187} {:x 230/33, :y 0.009101448429106639} {:x 235/33, :y 0.007518133229683001} {:x 80/11, :y 0.006174716395760555} {:x 245/33, :y 0.005042332792223683} {:x 250/33, :y 0.004094053263393624} {:x 85/11, :y 0.0033050875186944255} {:x 260/33, :y 0.002652894212643802} {:x 265/33, :y 0.002117212225924384} {:x 90/11, :y 0.0016800273299080965} {:x 25/3, :y 0.0013254879772150497} {:x 280/33, :y 0.0010397830454919879} {:x 95/11, :y 8.10993107200834E-4} {:x 290/33, :y 6.289253312080865E-4} {:x 295/33, :y 4.849405535559764E-4} {:x 100/11, :y 3.7177947793890046E-4} {:x 305/33, :y 2.833934545377709E-4} {:x 310/33, :y 2.1478389305454535E-4} {:x 105/11, :y 1.618531280464772E-4} {:x 320/33, :y 1.212684920196218E-4} {:x 325/33, :y 9.034047084076489E-5} {:x 10N, :y 6.691511288244271E-5})} {:name \"4ff6c03c-ad50-4947-9d08-e8c2cb958d64\", :values ({:x -5.324750349872502, :y 0} {:x -5.1754624014524895, :y 6.698464347480738E-4} {:x -5.026174453032477, :y 0.0} {:x -4.876886504612464, :y 0.0} {:x -4.727598556192451, :y 6.698464347480738E-4} {:x -4.578310607772438, :y 6.698464347480738E-4} {:x -4.429022659352425, :y 0.002679385738992295} {:x -4.279734710932412, :y 0.0013396928694961476} {:x -4.130446762512399, :y 6.698464347480738E-4} {:x -3.981158814092386, :y 0.003349232173740369} {:x -3.8318708656723732, :y 0.0020095393042442213} {:x -3.6825829172523603, :y 0.003349232173740369} {:x -3.5332949688323474, :y 0.002679385738992295} {:x -3.3840070204123345, :y 0.0013396928694961476} {:x -3.2347190719923216, :y 0.009377850086473034} {:x -3.0854311235723086, :y 0.004688925043236517} {:x -2.9361431751522957, :y 0.00870800365172496} {:x -2.786855226732283, :y 0.0073683107822288115} {:x -2.63756727831227, :y 0.014736621564457623} {:x -2.488279329892257, :y 0.01741600730344992} {:x -2.338991381472244, :y 0.01607631443395377} {:x -2.189703433052231, :y 0.012057235825465328} {:x -2.0404154846322182, :y 0.01942554660769414} {:x -1.8911275362122053, :y 0.01942554660769414} {:x -1.7418395877921924, :y 0.037511400345892135} {:x -1.5925516393721795, :y 0.03617170747639598} {:x -1.4432636909521666, :y 0.050238482606105535} {:x -1.2939757425321536, :y 0.056267100518838195} {:x -1.1446877941121407, :y 0.059616332692578565} {:x -0.9953998456921278, :y 0.06832433634430353} {:x -0.8461118972721149, :y 0.06430525773581508} {:x -0.696823948852102, :y 0.08038157216976885} {:x -0.547536000432089, :y 0.08373080434350923} {:x -0.39824805201207614, :y 0.08105141860451692} {:x -0.2489601035920632, :y 0.09846742590796685} {:x -0.09967215517205025, :y 0.10181665808170721} {:x 0.0496157932479627, :y 0.11320404747242448} {:x 0.19890374166797564, :y 0.1379883655581032} {:x 0.34819169008798856, :y 0.13530897981911091} {:x 0.4974796385080015, :y 0.14669636920982815} {:x 0.6467675869280144, :y 0.15004560138356854} {:x 0.7960555353480273, :y 0.15473452642680505} {:x 0.9453434837680402, :y 0.17750930520823954} {:x 1.0946314321880533, :y 0.17549976590399533} {:x 1.2439193806080662, :y 0.19492531251168949} {:x 1.393207329028079, :y 0.20564285546765865} {:x 1.542495277448092, :y 0.19425546607694139} {:x 1.691783225868105, :y 0.19291577320744524} {:x 1.8410711742881178, :y 0.20095393042442214} {:x 1.9903591227081308, :y 0.18219823025147608} {:x 2.139647071128144, :y 0.20296346972866636} {:x 2.288935019548157, :y 0.20497300903291057} {:x 2.4382229679681697, :y 0.17817915164298762} {:x 2.5875109163881826, :y 0.1935856196421933} {:x 2.7367988648081956, :y 0.18018869094723186} {:x 2.8860868132282085, :y 0.1868871552947126} {:x 3.0353747616482214, :y 0.19425546607694139} {:x 3.1846627100682343, :y 0.17282038016500303} {:x 3.3339506584882472, :y 0.15741391216579734} {:x 3.48323860690826, :y 0.15540437286155312} {:x 3.632526555328273, :y 0.13731851912335513} {:x 3.781814503748286, :y 0.13932805842759935} {:x 3.931102452168299, :y 0.1332994405148667} {:x 4.080390400588312, :y 0.13062005477587438} {:x 4.229678349008325, :y 0.09913727234271492} {:x 4.378966297428338, :y 0.09913727234271492} {:x 4.528254245848351, :y 0.099807118777463} {:x 4.677542194268364, :y 0.09846742590796685} {:x 4.826830142688377, :y 0.08373080434350923} {:x 4.97611809110839, :y 0.06497510417056315} {:x 5.125406039528403, :y 0.06162587199682279} {:x 5.274693987948416, :y 0.05157817547560168} {:x 5.4239819363684285, :y 0.03818124678064021} {:x 5.573269884788441, :y 0.04621940399761709} {:x 5.722557833208454, :y 0.03617170747639598} {:x 5.871845781628467, :y 0.034162168172151765} {:x 6.02113373004848, :y 0.03014308956366332} {:x 6.170421678468493, :y 0.022104932346686434} {:x 6.319709626888506, :y 0.024114471650930655} {:x 6.468997575308519, :y 0.01808585373819799} {:x 6.618285523728532, :y 0.018755700172946067} {:x 6.767573472148545, :y 0.013396928694961476} {:x 6.916861420568558, :y 0.01607631443395377} {:x 7.066149368988571, :y 0.008038157216976885} {:x 7.2154373174085835, :y 0.012057235825465328} {:x 7.364725265828596, :y 0.0013396928694961476} {:x 7.514013214248609, :y 0.006698464347480738} {:x 7.663301162668622, :y 0.003349232173740369} {:x 7.812589111088635, :y 0.003349232173740369} {:x 7.961877059508648, :y 0.002679385738992295} {:x 8.111165007928662, :y 0.002679385738992295} {:x 8.260452956348676, :y 0.0020095393042442213} {:x 8.40974090476869, :y 0.0} {:x 8.559028853188703, :y 6.698464347480738E-4} {:x 8.708316801608717, :y 0.0} {:x 8.857604750028731, :y 0.0} {:x 9.006892698448745, :y 6.698464347480738E-4} {:x 9.156180646868759, :y 0.0013396928694961476} {:x 9.305468595288772, :y 0.0} {:x 9.454756543708786, :y 6.698464347480738E-4} {:x 9.6040444921288, :y 0.0013396928694961476} {:x 9.753332440548814, :y 0})}), :marks ({:type \"line\", :from {:data \"0abba31a-a623-4bff-b761-1d8f1fefcb90\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"4ff6c03c-ad50-4947-9d08-e8c2cb958d64\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; **
;;; What is interesting, however, is that one can't immediately deduce, even in this very simple example, that the return value from the `marsaglia-normal` procedure is "scorable" in the sense that it can be "observed" in Anglican. 
;;; 
;;; In order to define an observable distribution in Anglican one must make these procedures scorable which means, for now, manually deriving and providing a log-pdf/pmf calculator.  
;; **

;; @@
(defdist my-normal
  "univariate normal with parameters mean and _variance_"
  [m v] []
    (sample [this] (marsaglia-normal m v))
    (observe [this value] (normal-lnpdf value m (sqrt v))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#&lt;MultiFn clojure.lang.MultiFn@3f51f08&gt;</span>","value":"#<MultiFn clojure.lang.MultiFn@3f51f08>"}
;; <=

;; **
;;; This can now be included in any Anglican program and used as a distribution, to be observed, etc.
;;; 
;;; Alternatively we can also include the sampling procedure directly by defm'ing it which produces a CPS version.
;; **

;; @@
(defm marsaglia-normal-cps [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal-cps mean var))))
;(marsaglia-normal 8 9 (prn) {})
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal-cps</span>","value":"#'marsaglia/marsaglia-normal-cps"}
;; <=

;; **
;;; What is interesting about this is that it exposes the internal random state of the `marsaglia-normal` to the inference engine.  This may or may not be a good idea depending on a number of issues.
;;; 
;;; Here is the Gaussian unknown mean example from the Anglican paper.
;; **

;; @@
(defquery unknown-mean-1 [d] 
    (let [sigma (sqrt 2)
          mu (marsaglia-normal-cps 1 5)]
      
          (observe (normal mu sigma) 9)
          (observe (normal mu sigma) 8)

          (predict :mu mu)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-1</span>","value":"#'marsaglia/unknown-mean-1"}
;; <=

;; **
;;; And here is the same in a more idiomatically Clojure-esq way.
;; **

;; @@
  (def data [9 8])

  (defquery unknown-mean-2 [d] 
    (let [sigma (sqrt 2)
          mu (marsaglia-normal-cps 1 5)
          obsdist (normal mu sigma)]
          (map (fn [d] (observe obsdist d)) data)
          (predict :mu mu)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-2</span>","value":"#'marsaglia/unknown-mean-2"}
;; <=

;; **
;;; |And here are the results.  One can use any of the available inference engines to draw samples from the conditional distribution defined by this query.
;; **

;; @@


[:lmh :pgibbs :pcascade :smc]

(plot/compose  
  (plot/list-plot 
     (->> (linspace 3 11 100)
          (map #(into []  
                      [% (exp (observe (my-normal 7.25 0.913) %))]))
          (into [])) :joined true)
  
  (->> (doquery :pcascade unknown-mean-2 nil :number-of-particles 10 :number-of-threads 1000)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(plot/histogram % :normalize :probability-density :bins 100))))


(->> (doquery :pcascade unknown-mean-2 nil :number-of-particles 10 :number-of-threads 1000)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(/ (reduce + %) (count %))))
      
  
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-double'>7.188730871244214</span>","value":"7.188730871244214"}
;; <=

;; **
;;; Which is near the analytical posterior of $$\mathrm{Normal}(7.25,.913^2)$$
;; **

;; @@

;; @@
