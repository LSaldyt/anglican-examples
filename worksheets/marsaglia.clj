;; gorilla-repl.fileformat = 1

;; **
;;; # Marsaglia
;;; 
;;; In probabilistic programming systems like Anglican that support _continuous_ variables, recursion, and branching on nondeterminism it is possible to write procedures in the language itself that sample from distributions with uncountable support.  Another way of saying this is that we can denote constructive definitions of distribution over uncountable support and sample from the same.
;; **

;; @@
(ns marsaglia
  (:require [gorilla-plot.core :as plot])
  (:use clojure.repl
        [mrepl core]
        [embang runtime emit]
        [clojure.string :only (join split blank?)]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; We can generate from a normal distribution in a number of ways.  A canonical method is to use the Marsaglia algorithm.
;; **

;; @@
(defn marsaglia-normal [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal mean var))))
     
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal</span>","value":"#'marsaglia/marsaglia-normal"}
;; <=

;; **
;;; We can check that this generator produces a sample distribution that is in accordance with our understanding of the normal distribution.
;; **

;; @@
(defn linspace [min max n]
   (let [step (/ (- max min) (dec n))] 
      (range min (+ max step) step)))


(plot/compose  
  (plot/list-plot 
     (->> (linspace -5 10 100)
          (map #(into []  
                      [% (exp (observe (normal 2 2) %))]))
          (into [])) :joined true)
  
  (plot/histogram 
    (repeatedly 10000 
       (partial marsaglia-normal 2 4)) 
       :normalise :probability-density :bins 100))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"bottom":20,"top":10,"right":10,"left":50},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"34ec2b9d-b69e-4440-a801-a95403bb2bbd","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"34ec2b9d-b69e-4440-a801-a95403bb2bbd","field":"data.y"}}],"axes":[{"scale":"x","type":"x"},{"scale":"y","type":"y"}],"data":[{"name":"34ec2b9d-b69e-4440-a801-a95403bb2bbd","values":[{"x":-5,"y":4.3634134752288024E-4},{"x":-4.848484848484848,"y":5.671970386513821E-4},{"x":-4.696969696969697,"y":7.330760541955561E-4},{"x":-4.545454545454545,"y":9.420449050769079E-4},{"x":-4.393939393939394,"y":0.001203654016099044},{"x":-4.242424242424242,"y":0.0015291117517670808},{"x":-4.090909090909091,"y":0.0019314535825149738},{"x":-3.939393939393939,"y":0.002425698488243101},{"x":-3.787878787878788,"y":0.0030289831142058456},{"x":-3.636363636363636,"y":0.0037606626743546664},{"x":-3.484848484848485,"y":0.004642366243399361},{"x":-3.333333333333333,"y":0.005697993011898718},{"x":-3.181818181818182,"y":0.0069536354318799525},{"x":-3.03030303030303,"y":0.008437415093311133},{"x":-2.878787878787879,"y":0.010179217781743332},{"x":-2.727272727272727,"y":0.012210315600134771},{"x":-2.575757575757576,"y":0.014562866395343413},{"x":-2.424242424242424,"y":0.01726928407836528},{"x":-2.272727272727273,"y":0.02036147778541646},{"x":-2.121212121212121,"y":0.023869963153426765},{"x":-1.96969696969697,"y":0.02782285516898323},{"x":-1.818181818181818,"y":0.03224475891046641},{"x":-1.666666666666667,"y":0.03715558177949653},{"x":-1.515151515151515,"y":0.04256929817839459},{"x":-1.363636363636364,"y":0.04849270464169628},{"x":-1.212121212121212,"y":0.05492420973253507},{"x":-1.060606060606061,"y":0.061852708105975915},{"x":-0.9090909090909091,"y":0.06925659156197403},{"x":-0.7575757575757576,"y":0.07710295123647007},{"x":-0.6060606060606061,"y":0.08534702395452404},{"x":-0.4545454545454545,"y":0.09393193193992502},{"x":-0.303030303030303,"y":0.10278875841821113},{"x":-0.1515151515151515,"y":0.11183699219670964},{"x":0,"y":0.12098536225957167},{"x":0.1515151515151515,"y":0.13013306915798126},{"x":0.303030303030303,"y":0.13917140405585637},{"x":0.4545454545454545,"y":0.14798572940993077},{"x":0.6060606060606061,"y":0.15645777823895984},{"x":0.7575757575757576,"y":0.16446821266387915},{"x":0.9090909090909091,"y":0.17189936779597245},{"x":1.060606060606061,"y":0.17863809499576255},{"x":1.212121212121212,"y":0.1845786098098487},{"x":1.363636363636364,"y":0.18962524515457918},{"x":1.515151515151515,"y":0.19369500999336653},{"x":1.666666666666667,"y":0.19671985805096995},{"x":1.818181818181818,"y":0.19864857996587088},{"x":1.96969696969697,"y":0.1994482453783368},{"x":2.121212121212121,"y":0.19910513821138476},{"x":2.272727272727273,"y":0.19762514802646214},{"x":2.424242424242424,"y":0.1950336018506434},{"x":2.575757575757576,"y":0.19137454318543307},{"x":2.727272727272727,"y":0.18670948687698946},{"x":2.878787878787879,"y":0.18111569903330255},{"x":3.03030303030303,"y":0.17468406918632726},{"x":3.181818181818182,"y":0.16751665654118497},{"x":3.333333333333333,"y":0.15972400276117615},{"x":3.484848484848485,"y":0.15142230988016653},{"x":3.636363636363636,"y":0.14273058344920256},{"x":3.787878787878788,"y":0.13376783801223838},{"x":3.939393939393939,"y":0.12465045481480107},{"x":4.090909090909091,"y":0.11548977084320669},{"x":4.242424242424242,"y":0.1063899646054096},{"x":4.393939393939394,"y":0.09744628834948768},{"x":4.545454545454545,"y":0.08874367958231383},{"x":4.696969696969697,"y":0.08035576770889953},{"x":4.848484848484848,"y":0.07234427521687632},{"x":5,"y":0.06475879783294586},{"x":5.151515151515152,"y":0.057636935092212856},{"x":5.303030303030303,"y":0.051004732236744024},{"x":5.454545454545455,"y":0.044877386570662106},{"x":5.606060606060606,"y":0.03926016644494568},{"x":5.757575757575758,"y":0.03414948886235444},{"x":5.909090909090909,"y":0.02953410207628976},{"x":6.060606060606061,"y":0.025396322187902},{"x":6.212121212121212,"y":0.02171327722262099},{"x":6.363636363636364,"y":0.018458118041464293},{"x":6.515151515151515,"y":0.015601162248989803},{"x":6.666666666666667,"y":0.013110944546854741},{"x":6.818181818181818,"y":0.01095515433554187},{"x":6.96969696969697,"y":0.009101448429106639},{"x":7.121212121212121,"y":0.007518133229683007},{"x":7.272727272727273,"y":0.006174716395760555},{"x":7.424242424242424,"y":0.005042332792223683},{"x":7.575757575757576,"y":0.004094053263393624},{"x":7.727272727272727,"y":0.003305087518694431},{"x":7.878787878787879,"y":0.0026528942126438043},{"x":8.03030303030303,"y":0.002117212225924388},{"x":8.181818181818182,"y":0.0016800273299080993},{"x":8.333333333333332,"y":0.0013254879772150556},{"x":8.484848484848484,"y":0.0010397830454919879},{"x":8.636363636363637,"y":8.109931072008354E-4},{"x":8.787878787878787,"y":6.289253312080876E-4},{"x":8.93939393939394,"y":4.849405535559756E-4},{"x":9.090909090909092,"y":3.7177947793890046E-4},{"x":9.242424242424242,"y":2.833934545377709E-4},{"x":9.393939393939394,"y":2.147838930545446E-4},{"x":9.545454545454545,"y":1.618531280464775E-4},{"x":9.696969696969697,"y":1.212684920196218E-4},{"x":9.848484848484848,"y":9.034047084076505E-5},{"x":10,"y":6.691511288244271E-5}]},{"name":"0db7327e-2136-4074-b9e3-c694065b8ac3","values":[{"x":-5.426361740362126,"y":0},{"x":-5.282338503283431,"y":0.0020829972029866146},{"x":-5.138315266204736,"y":0.0},{"x":-4.994292029126041,"y":0.0},{"x":-4.850268792047346,"y":6.943324009955382E-4},{"x":-4.706245554968651,"y":6.943324009955382E-4},{"x":-4.5622223178899555,"y":0.0},{"x":-4.41819908081126,"y":0.003471662004977691},{"x":-4.274175843732565,"y":0.0013886648019910764},{"x":-4.13015260665387,"y":0.0013886648019910764},{"x":-3.986129369575175,"y":0.0013886648019910764},{"x":-3.84210613249648,"y":0.0055546592079643055},{"x":-3.6980828954177847,"y":0.003471662004977691},{"x":-3.5540596583390895,"y":6.943324009955382E-4},{"x":-3.4100364212603944,"y":0.0020829972029866146},{"x":-3.2660131841816993,"y":0.0055546592079643055},{"x":-3.121989947103004,"y":0.00763765641095092},{"x":-2.977966710024309,"y":0.006248991608959843},{"x":-2.833943472945614,"y":0.009720653613937534},{"x":-2.6899202358669188,"y":0.00763765641095092},{"x":-2.5458969987882236,"y":0.018052642425883992},{"x":-2.4018737617095285,"y":0.012497983217919686},{"x":-2.2578505246308334,"y":0.018052642425883992},{"x":-2.1138272875521382,"y":0.028467628440817065},{"x":-1.969804050473443,"y":0.024995966435839373},{"x":-1.825780813394748,"y":0.03124495804479922},{"x":-1.6817575763160528,"y":0.026384631237830452},{"x":-1.5377343392373577,"y":0.034022287648781374},{"x":-1.3937111021586626,"y":0.03471662004977691},{"x":-1.2496878650799674,"y":0.05971258648561628},{"x":-1.1056646280012723,"y":0.047908935668692136},{"x":-0.9616413909225772,"y":0.06040691888661182},{"x":-0.817618153843882,"y":0.07151623730254043},{"x":-0.6735949167651869,"y":0.07151623730254043},{"x":-0.5295716796864918,"y":0.09304054173340212},{"x":-0.38554844260779664,"y":0.10484419255032626},{"x":-0.24152520552910153,"y":0.10831585455530396},{"x":-0.09750196845040643,"y":0.09373487413439766},{"x":0.046521268628288676,"y":0.11734217576824596},{"x":0.19054450570698378,"y":0.13539481819412993},{"x":0.3345677427856789,"y":0.12289683497621026},{"x":0.47859097986437404,"y":0.15761345502598717},{"x":0.6226142169430692,"y":0.16594544383793364},{"x":0.7666374540217643,"y":0.14650413661005857},{"x":0.9106606911004594,"y":0.18677541586779978},{"x":1.0546839281791545,"y":0.15344746062001394},{"x":1.1987071652578496,"y":0.16663977623892917},{"x":1.3427304023365447,"y":0.1763604298528667},{"x":1.4867536394152399,"y":0.20691105549667038},{"x":1.630776876493935,"y":0.1874697482687953},{"x":1.7748001135726301,"y":0.20760538789766592},{"x":1.9188233506513253,"y":0.1930244074767596},{"x":2.06284658773002,"y":0.20621672309567485},{"x":2.2068698248087153,"y":0.17913775945684884},{"x":2.3508930618874104,"y":0.19580173708074178},{"x":2.4949162989661056,"y":0.19580173708074178},{"x":2.6389395360448007,"y":0.21871470631359452},{"x":2.782962773123496,"y":0.1930244074767596},{"x":2.926986010202191,"y":0.20413372589268822},{"x":3.071009247280886,"y":0.16247378183295594},{"x":3.215032484359581,"y":0.16872277344191577},{"x":3.3590557214382764,"y":0.15344746062001394},{"x":3.5030789585169715,"y":0.154836125422005},{"x":3.6471021955956666,"y":0.14650413661005857},{"x":3.7911254326743618,"y":0.13192315618915226},{"x":3.935148669753057,"y":0.1381721477981121},{"x":4.079171906831752,"y":0.11317618136227273},{"x":4.223195143910447,"y":0.10692718975331288},{"x":4.367218380989142,"y":0.10137253054534857},{"x":4.511241618067837,"y":0.08887454732742889},{"x":4.655264855146532,"y":0.09859520094136642},{"x":4.799288092225227,"y":0.07359923450552705},{"x":4.943311329303922,"y":0.08609721772344674},{"x":5.0873345663826175,"y":0.06526724569358058},{"x":5.231357803461313,"y":0.0617955836886029},{"x":5.375381040540008,"y":0.06804457529756275},{"x":5.519404277618703,"y":0.05207493007466536},{"x":5.663427514697398,"y":0.03263362284679029},{"x":5.807450751776093,"y":0.03124495804479922},{"x":5.951473988854788,"y":0.024301634034843835},{"x":6.095497225933483,"y":0.024301634034843835},{"x":6.2395204630121786,"y":0.02291296923285276},{"x":6.383543700090874,"y":0.02291296923285276},{"x":6.527566937169569,"y":0.02013563962887061},{"x":6.671590174248264,"y":0.016663977623892916},{"x":6.815613411326959,"y":0.012497983217919686},{"x":6.959636648405654,"y":0.006248991608959843},{"x":7.103659885484349,"y":0.004860326806968767},{"x":7.2476831225630445,"y":0.006248991608959843},{"x":7.39170635964174,"y":0.006943324009955382},{"x":7.535729596720435,"y":0.004165994405973229},{"x":7.67975283379913,"y":0.004165994405973229},{"x":7.823776070877825,"y":0.0013886648019910764},{"x":7.96779930795652,"y":0.004165994405973229},{"x":8.111822545035215,"y":0.003471662004977691},{"x":8.25584578211391,"y":0.0020829972029866146},{"x":8.399869019192606,"y":0.0013886648019910764},{"x":8.5438922562713,"y":0.0013886648019910764},{"x":8.687915493349996,"y":6.943324009955382E-4},{"x":8.831938730428691,"y":0.0},{"x":8.975961967507386,"y":6.943324009955382E-4},{"x":9.119985204586081,"y":0}]}],"marks":[{"type":"line","from":{"data":"34ec2b9d-b69e-4440-a801-a95403bb2bbd"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"0db7327e-2136-4074-b9e3-c694065b8ac3"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:bottom 20, :top 10, :right 10, :left 50}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"34ec2b9d-b69e-4440-a801-a95403bb2bbd\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"34ec2b9d-b69e-4440-a801-a95403bb2bbd\", :field \"data.y\"}}], :axes [{:scale \"x\", :type \"x\"} {:scale \"y\", :type \"y\"}], :data ({:name \"34ec2b9d-b69e-4440-a801-a95403bb2bbd\", :values ({:x -5, :y 4.3634134752288024E-4} {:x -160/33, :y 5.671970386513821E-4} {:x -155/33, :y 7.330760541955561E-4} {:x -50/11, :y 9.420449050769079E-4} {:x -145/33, :y 0.001203654016099044} {:x -140/33, :y 0.0015291117517670808} {:x -45/11, :y 0.0019314535825149738} {:x -130/33, :y 0.002425698488243101} {:x -125/33, :y 0.0030289831142058456} {:x -40/11, :y 0.0037606626743546664} {:x -115/33, :y 0.004642366243399361} {:x -10/3, :y 0.005697993011898718} {:x -35/11, :y 0.0069536354318799525} {:x -100/33, :y 0.008437415093311133} {:x -95/33, :y 0.010179217781743332} {:x -30/11, :y 0.012210315600134771} {:x -85/33, :y 0.014562866395343413} {:x -80/33, :y 0.01726928407836528} {:x -25/11, :y 0.02036147778541646} {:x -70/33, :y 0.023869963153426765} {:x -65/33, :y 0.02782285516898323} {:x -20/11, :y 0.03224475891046641} {:x -5/3, :y 0.03715558177949653} {:x -50/33, :y 0.04256929817839459} {:x -15/11, :y 0.04849270464169628} {:x -40/33, :y 0.05492420973253507} {:x -35/33, :y 0.061852708105975915} {:x -10/11, :y 0.06925659156197403} {:x -25/33, :y 0.07710295123647007} {:x -20/33, :y 0.08534702395452404} {:x -5/11, :y 0.09393193193992502} {:x -10/33, :y 0.10278875841821113} {:x -5/33, :y 0.11183699219670964} {:x 0N, :y 0.12098536225957167} {:x 5/33, :y 0.13013306915798126} {:x 10/33, :y 0.13917140405585637} {:x 5/11, :y 0.14798572940993077} {:x 20/33, :y 0.15645777823895984} {:x 25/33, :y 0.16446821266387915} {:x 10/11, :y 0.17189936779597245} {:x 35/33, :y 0.17863809499576255} {:x 40/33, :y 0.1845786098098487} {:x 15/11, :y 0.18962524515457918} {:x 50/33, :y 0.19369500999336653} {:x 5/3, :y 0.19671985805096995} {:x 20/11, :y 0.19864857996587088} {:x 65/33, :y 0.1994482453783368} {:x 70/33, :y 0.19910513821138476} {:x 25/11, :y 0.19762514802646214} {:x 80/33, :y 0.1950336018506434} {:x 85/33, :y 0.19137454318543307} {:x 30/11, :y 0.18670948687698946} {:x 95/33, :y 0.18111569903330255} {:x 100/33, :y 0.17468406918632726} {:x 35/11, :y 0.16751665654118497} {:x 10/3, :y 0.15972400276117615} {:x 115/33, :y 0.15142230988016653} {:x 40/11, :y 0.14273058344920256} {:x 125/33, :y 0.13376783801223838} {:x 130/33, :y 0.12465045481480107} {:x 45/11, :y 0.11548977084320669} {:x 140/33, :y 0.1063899646054096} {:x 145/33, :y 0.09744628834948768} {:x 50/11, :y 0.08874367958231383} {:x 155/33, :y 0.08035576770889953} {:x 160/33, :y 0.07234427521687632} {:x 5N, :y 0.06475879783294586} {:x 170/33, :y 0.057636935092212856} {:x 175/33, :y 0.051004732236744024} {:x 60/11, :y 0.044877386570662106} {:x 185/33, :y 0.03926016644494568} {:x 190/33, :y 0.03414948886235444} {:x 65/11, :y 0.02953410207628976} {:x 200/33, :y 0.025396322187902} {:x 205/33, :y 0.02171327722262099} {:x 70/11, :y 0.018458118041464293} {:x 215/33, :y 0.015601162248989803} {:x 20/3, :y 0.013110944546854741} {:x 75/11, :y 0.01095515433554187} {:x 230/33, :y 0.009101448429106639} {:x 235/33, :y 0.007518133229683007} {:x 80/11, :y 0.006174716395760555} {:x 245/33, :y 0.005042332792223683} {:x 250/33, :y 0.004094053263393624} {:x 85/11, :y 0.003305087518694431} {:x 260/33, :y 0.0026528942126438043} {:x 265/33, :y 0.002117212225924388} {:x 90/11, :y 0.0016800273299080993} {:x 25/3, :y 0.0013254879772150556} {:x 280/33, :y 0.0010397830454919879} {:x 95/11, :y 8.109931072008354E-4} {:x 290/33, :y 6.289253312080876E-4} {:x 295/33, :y 4.849405535559756E-4} {:x 100/11, :y 3.7177947793890046E-4} {:x 305/33, :y 2.833934545377709E-4} {:x 310/33, :y 2.147838930545446E-4} {:x 105/11, :y 1.618531280464775E-4} {:x 320/33, :y 1.212684920196218E-4} {:x 325/33, :y 9.034047084076505E-5} {:x 10N, :y 6.691511288244271E-5})} {:name \"0db7327e-2136-4074-b9e3-c694065b8ac3\", :values ({:x -5.426361740362126, :y 0} {:x -5.282338503283431, :y 0.0020829972029866146} {:x -5.138315266204736, :y 0.0} {:x -4.994292029126041, :y 0.0} {:x -4.850268792047346, :y 6.943324009955382E-4} {:x -4.706245554968651, :y 6.943324009955382E-4} {:x -4.5622223178899555, :y 0.0} {:x -4.41819908081126, :y 0.003471662004977691} {:x -4.274175843732565, :y 0.0013886648019910764} {:x -4.13015260665387, :y 0.0013886648019910764} {:x -3.986129369575175, :y 0.0013886648019910764} {:x -3.84210613249648, :y 0.0055546592079643055} {:x -3.6980828954177847, :y 0.003471662004977691} {:x -3.5540596583390895, :y 6.943324009955382E-4} {:x -3.4100364212603944, :y 0.0020829972029866146} {:x -3.2660131841816993, :y 0.0055546592079643055} {:x -3.121989947103004, :y 0.00763765641095092} {:x -2.977966710024309, :y 0.006248991608959843} {:x -2.833943472945614, :y 0.009720653613937534} {:x -2.6899202358669188, :y 0.00763765641095092} {:x -2.5458969987882236, :y 0.018052642425883992} {:x -2.4018737617095285, :y 0.012497983217919686} {:x -2.2578505246308334, :y 0.018052642425883992} {:x -2.1138272875521382, :y 0.028467628440817065} {:x -1.969804050473443, :y 0.024995966435839373} {:x -1.825780813394748, :y 0.03124495804479922} {:x -1.6817575763160528, :y 0.026384631237830452} {:x -1.5377343392373577, :y 0.034022287648781374} {:x -1.3937111021586626, :y 0.03471662004977691} {:x -1.2496878650799674, :y 0.05971258648561628} {:x -1.1056646280012723, :y 0.047908935668692136} {:x -0.9616413909225772, :y 0.06040691888661182} {:x -0.817618153843882, :y 0.07151623730254043} {:x -0.6735949167651869, :y 0.07151623730254043} {:x -0.5295716796864918, :y 0.09304054173340212} {:x -0.38554844260779664, :y 0.10484419255032626} {:x -0.24152520552910153, :y 0.10831585455530396} {:x -0.09750196845040643, :y 0.09373487413439766} {:x 0.046521268628288676, :y 0.11734217576824596} {:x 0.19054450570698378, :y 0.13539481819412993} {:x 0.3345677427856789, :y 0.12289683497621026} {:x 0.47859097986437404, :y 0.15761345502598717} {:x 0.6226142169430692, :y 0.16594544383793364} {:x 0.7666374540217643, :y 0.14650413661005857} {:x 0.9106606911004594, :y 0.18677541586779978} {:x 1.0546839281791545, :y 0.15344746062001394} {:x 1.1987071652578496, :y 0.16663977623892917} {:x 1.3427304023365447, :y 0.1763604298528667} {:x 1.4867536394152399, :y 0.20691105549667038} {:x 1.630776876493935, :y 0.1874697482687953} {:x 1.7748001135726301, :y 0.20760538789766592} {:x 1.9188233506513253, :y 0.1930244074767596} {:x 2.06284658773002, :y 0.20621672309567485} {:x 2.2068698248087153, :y 0.17913775945684884} {:x 2.3508930618874104, :y 0.19580173708074178} {:x 2.4949162989661056, :y 0.19580173708074178} {:x 2.6389395360448007, :y 0.21871470631359452} {:x 2.782962773123496, :y 0.1930244074767596} {:x 2.926986010202191, :y 0.20413372589268822} {:x 3.071009247280886, :y 0.16247378183295594} {:x 3.215032484359581, :y 0.16872277344191577} {:x 3.3590557214382764, :y 0.15344746062001394} {:x 3.5030789585169715, :y 0.154836125422005} {:x 3.6471021955956666, :y 0.14650413661005857} {:x 3.7911254326743618, :y 0.13192315618915226} {:x 3.935148669753057, :y 0.1381721477981121} {:x 4.079171906831752, :y 0.11317618136227273} {:x 4.223195143910447, :y 0.10692718975331288} {:x 4.367218380989142, :y 0.10137253054534857} {:x 4.511241618067837, :y 0.08887454732742889} {:x 4.655264855146532, :y 0.09859520094136642} {:x 4.799288092225227, :y 0.07359923450552705} {:x 4.943311329303922, :y 0.08609721772344674} {:x 5.0873345663826175, :y 0.06526724569358058} {:x 5.231357803461313, :y 0.0617955836886029} {:x 5.375381040540008, :y 0.06804457529756275} {:x 5.519404277618703, :y 0.05207493007466536} {:x 5.663427514697398, :y 0.03263362284679029} {:x 5.807450751776093, :y 0.03124495804479922} {:x 5.951473988854788, :y 0.024301634034843835} {:x 6.095497225933483, :y 0.024301634034843835} {:x 6.2395204630121786, :y 0.02291296923285276} {:x 6.383543700090874, :y 0.02291296923285276} {:x 6.527566937169569, :y 0.02013563962887061} {:x 6.671590174248264, :y 0.016663977623892916} {:x 6.815613411326959, :y 0.012497983217919686} {:x 6.959636648405654, :y 0.006248991608959843} {:x 7.103659885484349, :y 0.004860326806968767} {:x 7.2476831225630445, :y 0.006248991608959843} {:x 7.39170635964174, :y 0.006943324009955382} {:x 7.535729596720435, :y 0.004165994405973229} {:x 7.67975283379913, :y 0.004165994405973229} {:x 7.823776070877825, :y 0.0013886648019910764} {:x 7.96779930795652, :y 0.004165994405973229} {:x 8.111822545035215, :y 0.003471662004977691} {:x 8.25584578211391, :y 0.0020829972029866146} {:x 8.399869019192606, :y 0.0013886648019910764} {:x 8.5438922562713, :y 0.0013886648019910764} {:x 8.687915493349996, :y 6.943324009955382E-4} {:x 8.831938730428691, :y 0.0} {:x 8.975961967507386, :y 6.943324009955382E-4} {:x 9.119985204586081, :y 0})}), :marks ({:type \"line\", :from {:data \"34ec2b9d-b69e-4440-a801-a95403bb2bbd\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"0db7327e-2136-4074-b9e3-c694065b8ac3\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}
;; <=

;; **
;;; What is interesting, however, is that one can't immediately deduce, even in this very simple example, that the return value from this procedure is "scorable" in the sense that it can be "observed" in Anglican. 
;;; 
;;; In order to make these procedures scorable one must, for now, be able to provide a log-pdf/pmf calculator.  
;; **

;; @@
(defdist my-normal
  "univariate normal with parameters mean and _variance_"
  [m v] []
    (sample [this] (marsaglia-normal m v))
    (observe [this value] (observe (normal m (sqrt v)) value)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#&lt;MultiFn clojure.lang.MultiFn@1d1edba3&gt;</span>","value":"#<MultiFn clojure.lang.MultiFn@1d1edba3>"}
;; <=

;; **
;;; This can now be included in any Anglican program and used as a distribution, to be observed, etc.
;;; 
;;; Alternatively we can also include the sampling procedure directly by defm'ing it which produces a CPS version.
;; **

;; @@
(defm marsaglia-normal-cps [mean var]
  (let [d (uniform-continuous -1.0 1.0)
        x (sample d)
        y (sample d)
        s (+ (* x x ) (* y y ))]
          (if (< s 1)
            (+ mean (* (sqrt var)
				       (* x (sqrt (* -2 (/ ( log s) s ))))))
            (marsaglia-normal-cps mean var))))
;(marsaglia-normal 8 9 (prn) {})
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/marsaglia-normal-cps</span>","value":"#'marsaglia/marsaglia-normal-cps"}
;; <=

;; **
;;; What is interesting about this is that it exposes the internal random state of the `marsaglia-normal` to the inference engine.  This may or may not be a good idea depending on a number of issues.
;;; 
;;; Here is the Gaussian unknown mean example from the Anglican paper.
;; **

;; @@
(defquery unknown-mean-1 [d] 
    (let [sigma (sqrt 2)
          mu (marsaglia-normal-cps 1 5)]
      
          (observe (normal mu sigma) 9)
          (observe (normal mu sigma) 8)

          (predict :mu mu)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-1</span>","value":"#'marsaglia/unknown-mean-1"}
;; <=

;; **
;;; And here is the same in a more idiomatically Clojure-esq way.
;; **

;; @@
  (def data [9 8])

  (defquery unknown-mean-2 [d] 
    (let [sigma (sqrt 2)
          mu (marsaglia-normal-cps 1 5)
          obsdist (normal mu sigma)]
          (map (fn [d] (observe obsdist d)) data)
          (predict :mu mu)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;marsaglia/unknown-mean-2</span>","value":"#'marsaglia/unknown-mean-2"}
;; <=

;; **
;;; |And here are the results.  One can use any of the available inference engines to draw samples from the conditional distribution defined by this query.
;; **

;; **
;;; 
;; **

;; @@


[:lmh :pgibbs :pcascade :smc]

(plot/compose  
  (plot/list-plot 
     (->> (linspace 3 11 100)
          (map #(into []  
                      [% (exp (observe (normal 7.25 0.913) %))]))
          (into [])) :joined true)
  
  (->> (doquery :lmh unknown-mean-2 nil :number-of-particles 1000)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(plot/histogram % :normalize :probability-density :bins 100))))


(->> (doquery :lmh unknown-mean-2 nil :number-of-particles 1000)
     (map get-predicts)
     (map :mu)
     (take 20000)
     (#(/ (reduce + %) (count %))))
      
  
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-double'>7.361948402130541</span>","value":"7.361948402130541"}
;; <=

;; **
;;; Which is near the analytical posterior of $$\mathrm{Normal}(7.25,.913^2)$$
;; **

;; @@

;; @@
